<!DOCTYPE html>
<html lang="sk-SK">
<head>
	<!-- Primary Meta Tags -->
	<title>WiFi termostat - ESP8266 / ESP32 - Webserver - riadenie kotla v automatickom režime s hysterézou / manuálne ovládanie</title>
	<meta name="description" content="Izbový termostat navrhnutý na platforme Espressif - ESP8266 / ESP32. Termostat pre vykurovanie domácnosti s ovládaním plynového kotla.">
	<meta name="keywords" content="termostat, digitálny, arduino ide, wemos d1 mini, nodemcu, wifi, esp8266, vykurovanie, kúrenie, wifimanager, webserver, socket, http, web, ip, ipv4, ds18b20, onewire, 1-wire, esp32, nodemcu">
	<!-- Open Graph / Facebook -->
	<meta property="og:type" content="website">
	<meta property="og:url" content="https://martinius96.github.io/WiFi-termostat/">
	<meta property="og:title" content="WiFi termostat - ESP8266 / ESP32 - Webserver - riadenie kotla v automatickom režime s hysterézou / manuálne ovládanie">
	<meta property="og:description" content="Izbový termostat navrhnutý na platforme Espressif - ESP8266 / ESP32. Termostat pre vykurovanie domácnosti s ovládaním plynového kotla.">

	<!-- Twitter -->
	<meta property="twitter:card" content="summary_large_image">
	<meta property="twitter:url" content="https://martinius96.github.io/WiFi-termostat/">
	<meta property="twitter:title" content="WiFi termostat - ESP8266 / ESP32 - Webserver - riadenie kotla v automatickom režime s hysterézou / manuálne ovládanie">
	<meta property="twitter:description" content="Izbový termostat navrhnutý na platforme Espressif - ESP8266 / ESP32. Termostat pre vykurovanie domácnosti s ovládaním plynového kotla.">
	
	<link rel="icon" type="image/png" href="favicon.png">
	<link rel="sitemap" type="application/xml" title="Sitemap" href="../sitemap.xml" />
	<meta name="google-site-verification" content="UwZZh2EXv3iWUAi_1Z0hLxVCz6ySJ4UdY_BPoLtejwo" />    	
	<meta property='fb:admins' content='100001242570317'>
    	<meta charset="utf-8">
    	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
	<script type="text/javascript">
    		window.smartlook||(function(d) {
    			var o=smartlook=function(){ o.api.push(arguments)},h=d.getElementsByTagName('head')[0];
    			var c=d.createElement('script');o.api=new Array();c.async=true;c.type='text/javascript';
    			c.charset='utf-8';c.src='https://rec.smartlook.com/recorder.js';h.appendChild(c);
    		})(document);
    		smartlook('init', 'db50efe9fff280a17db52b82be221240cbbd3dbe');
	</script>    
		<style>
	#right {
  position: absolute;
  right: 0px;
}
	</style>
</head>
<body>
	<div class="container">
  		<div class="row">
    			<div class="col-sm-12">
<nav class="navbar navbar-inverse">
  <div class="container-fluid">
    <div class="navbar-header">
      <a class="navbar-brand" href="index.html">WiFi termostat</a>
    </div>
    <ul class="nav navbar-nav">
      	<li class="active"><a href="index.html">Prehľad</a></li>
	<li><a href="zapojenie.html">Zapojenie</a></li>      
	<li class=""><a href="spustenie.html">Firmvér</a></li>
  	<li><a href="json_client.html">JSON client</a></li>
      	<li><a href="kontakt.html">Kontakt</a></li>
<a href="de/index.html"><img src="https://futbalovysen.sk/wp-content/uploads/germany.png" alt="Germany.png, 2,2kB" title="Germany" height="32" width="32"></a>	
<a href="en/index.html"><img src="https://i2.wp.com/facsusa.com/wp-content/uploads/2017/05/Flag-of-England.png?ssl=1" alt="English.png, 2,2kB" title="English" height="32" width="32"></a>
	<li style="float: right; "><a href="https://martinius96.github.io/termostat-ethernet/" class="btn btn-danger" role="button" title="Zmeniť projekt na Ethernet termostat"><img src="https://i.imgur.com/6dW9TvK.png" width=16px height=16px> <font color="white">Ethernet termostat</font></a></li>
</ul>
  </div>
</nav>  
<div class="alert alert-success">
	<strong>Repozitár projektu WiFi termostat so strojovými kódmi pre cieľovú platformu ESP8266 a ESP32: </strong><a href="https://github.com/martinius96/WiFi-termostat/tree/main/firmware">Firmvér</a>
</div>	
<div class="alert alert-info">
	Firmvér <strong>WiFi_Termostat a WiFi_Termostat_mDNS</strong> je dostupný okrem slovenského, aj v anglickom jazyku. Experimentálny firmvér s manuálnym ovládaním výstupu je dostupný iba v slovenskom jazyku.
</div>
<div class="alert alert-danger">
 	<strong>Podporte projekt WiFi termostat cez PayPal. Podpora umožní pridať nové funkcionality v budúcnosti a otvorenie zdrojového kódu aplikácie: </strong><a href="https://www.paypal.com/paypalme/chlebovec" class="btn btn-primary" role="button">PayPal donate</a>
</div>		
<span class="label label-default">ESP8266</span>
<span class="label label-primary">ESP32</span>
<span class="label label-success">WiFi</span>
<span class="label label-info">DS18B20</span>
<span class="label label-warning">OneWire</span>
<span class="label label-danger">Dallas</span>
<span class="label label-default">HTML</span>
<span class="label label-primary">Webserver</span>
<span class="label label-success">WebSocket</span>
<span class="label label-info">JSON</span>
<span class="label label-warning">mDNS</span>	
<span class="label label-danger">UART</span>					
  <div class="row">
<div class="col-sm-4"><center><img src="https://i.imgur.com/koSyFuW.png" width="128px" height="128px" style="border-radius: 50%;" alt="Riadiaci mikrokontróler NodeMCU v2 / v3 Lolin - ESP8266-12E / ESP8266-12F" title="Riadiaci mikrokontróler NodeMCU v2 / v3 Lolin - ESP8266-12E / ESP8266-12F"><br><b>NodeMCU (ESP8266)</b><br><a href="https://www.gme.sk/nodemcu-esp8266-lua-wifi-v3-ch340" class="btn btn-success" role="button">Kúpiť GME.sk</a><br><a href="https://rlx.sk/sk/bezdratove-riesenia/4965-nodemcu-v2-esp8266-development-board-er-dpo28090b.html" class="btn btn-danger" role="button">Kúpiť RLX.sk</a><br><a href="https://techfun.sk/produkt/vyvojova-doska-node-mcu-esp12-e-v3-0-ch340g/" class="btn btn-primary" role="button">Kúpiť Techfun.sk</a></center></div>
	<div class="col-sm-4"><center><img src="https://i.imgur.com/FV9xi6K.png" width="128px" height="128px" style="border-radius: 50%;" alt="Riadiaci mikrokontróler Wemos D1 Mini - ESP8266-12E / ESP8266-12F" title="Riadiaci mikrokontróler Wemos D1 Mini - ESP8266-12E / ESP8266-12F"><br><b>Wemos D1 / D1 Mini (ESP8266)</b><br><a href="https://www.gme.sk/esp8266-esp-12e-wemos-d1-wifi-arduino-ide-uno-ch340" class="btn btn-success" role="button">Kúpiť GME.sk</a><br><a href="https://techfun.sk/produkt/vyvojova-doska-esp12-f-wemos-d1-mini/" class="btn btn-primary" role="button">Kúpiť Techfun.sk</a></center></div>
	<div class="col-sm-4"><center><img src="https://i.imgur.com/BczG03b.png" width="128px" height="128px" style="border-radius: 50%;" alt="Riadiaci mikrokontróler ESP32 Devkit V1 - ESP-WROOM-32 / ESP32-S" title="Riadiaci mikrokontróler ESP32 Devkit V1 - ESP-WROOM-32 / ESP32-S"><br><b>ESP32 DevKit</b><br><a href="https://www.gme.sk/esp32-esp-32s-2-4ghz-dual-mode-wifi-bluetooth" class="btn btn-success" role="button">Kúpiť GME.sk</a><br><a href="https://rlx.sk/sk/esp32/7196-nodemcu-32s-esp32-wifibluetooth-development-board-ws-16611.html" class="btn btn-danger" role="button">Kúpiť RLX.sk</a><br><a href="https://techfun.sk/produkt/vyvojova-doska-node-mcu-esp32-wifi-bluetooth/" class="btn btn-primary" role="button">Kúpiť Techfun.sk</a></center></div></div>					
<hr><center><h1>WiFi termostat - ESP8266 / ESP32</h1></center><hr>
<p style="text-align: justify;">
Naša programová implementácia je špeciálne navrhnutá pre mikrokontrólery od renomovaného výrobcu Espressif Systems, ktoré disponujú WiFi konektivitou. Podporujeme mikrokontroléry ESP8266 a ESP32 s WiFi (2,4 GHz) technológiou.
Náš WiFi termostat je ľahko prístupný prostredníctvom LAN siete, v ktorej sa nachádza. Je vybavený intuitívnym webovým rozhraním, ktoré umožňuje konfiguráciu všetkých parametrov termostatu a poskytuje vizuálny prehľad o aktuálnych stavoch.
Termostat efektívne riadi kotol na základe nameranej teploty, cieľovej hodnoty a definovanej hysterézy, pričom je nezávislý od webovej aplikácie. Webová aplikácia slúži výhradne na konfiguráciu a stanovenie rozhodovacích prahov termostatu.
Okrem jednoduchej dostupnosti termostatu na konkrétnej IP adrese je možné pridať mDNS záznam, ktorý vytvára lokálnu doménu (hostname.local). Táto doména je prístupná iba v rámci LAN siete, čo zvyšuje užívateľskú pohodlnosť v rámci multicastovej služby.
Konfigurácia termostatu pre domácu WiFi LAN sieť je jednoduchá vďaka WiFiManagerovi, ktorý bezpečne ukladá údaje o WiFi sieti (SSID a heslo) priamo do flash pamäte mikrokontroléra. Tieto údaje sú uložené permanentne, umožňujúc termostatu automatické pripojenie po získaní IP adresy od vášho routra v domácej WiFi sieti.
Náš HTTP webserver, bežiaci na mikrokontroléroch ESP8266 / ESP32, umožňuje simultánny beh viacerých nezávislých HTML stránok. Tieto stránky môžu slúžiť nielen informatívnym účelom, ale aj ako funkčné rozhranie, čím zvyšujú využiteľnosť nášho termostatu.
</p>
<b>Po hardvérovej stránke projekt využíva:</b>
<li>ESP8266 / ESP32</li>
<li>Teplotný senzor DS18B20 na OneWire zbernici</li>
<li>Relé SRD-5VDC-SL-C / OMRON G3MB-202P slúžiace na spínanie kotla (Active-LOW signál)</li>
<hr>
<b>HTML stránky bežiace na platforme ESP8266 / ESP32:</b>
<li><b>/</b> - root stránka obsahujúca formulár, aktuálny výpis logického výstupu pre relé, aktuálnu a cieľovú teplotu teplotu, hysterézu</li>
<li><b>/action.html</b> - spracúvava hodnoty z formulára, zapisuje ich do emulovanej EEPROM pamäte, presmeruje používateľa späť na root stránku</li>
<li><b>/get_data.json</b> - distribuuje dáta o aktuálnej teplote, referenčnej teplote a hysteréza tretej strane (počítač, mikrokontróler, iný klient...) v JSON formáte - možno využiť s príkladom JSON klient, ktorý dáta vie odoslať na MQTT Broker, napríklad do domácej automatizácie</li>
<hr>
<b>Rozšírené o HTML stránky v prípadne experimentálnej verzie s manuálnym režimom:</b>
<li><b>/zap.html</b> - permanentné zapnutie výstupu v manuálnom režime</li>
<li><b>/vyp.html</b> - permanentné vypnutie výstupu v manuálnom režime</li>
<li><b>/automat.html</b> - zmena režimu na automatický (používa hysterézu a cieľovú teplotu)</li>
<li><b>/manual.html</b> - zmena režimu na manuálny (permanentné ovládanie výstupu ZAP / VYP natvrdo)</li>
<hr>	
<p style="text-align: justify;">		
<b>Senzor DS18B20 s rozlíšením 12 bitov poskytuje presné merania s minimálnym krokom teploty 0.0625 °C. Dáta získané cez OneWire zbernicu môžu byť prenesené do mikrokontroléra za 500 až 1000 ms, pričom doba odpovede závisí od počtu pripojených senzorov a dĺžky zbernice.</b>
V našom projekte využívame elektromagnetické relé SRD-5VDC-SL-C, ktoré dokáže spínať až 10A pri 230V, čo zodpovedá výkonu 2300W. Pre jednosmerný obvod je možné spínať 300W (10A pri 30V DC). V prípade potreby je možné použiť aj SSR relé OMRON G3MB-202P, ktoré je ideálne pre neindukčné záťaže a určené výhradne pre obvody so striedavým napätím. Jeho maximálny spínaný výkon je 460W (230V, 2A).
<b>Termostat, vybavený týmito komponentmi, je vhodný na celoročné používanie. V prípade nevyžadovaného riadenia je možné fyzicky odpojiť výstup a využívať termostat ako WiFi teplomer pre monitorovanie teploty v danej miestnosti.</b>
</p>
<hr>
<p style="text-align: justify;">
V prípade, že používate firmware s možnosťou manuálneho ovládania GPIO výstupu mikrokontroléru ESP, je možné termostat fyzicky vypnúť bez nutnosti odpojenia zo svorkovnice relé. Logika termostatu sa vykonáva každých 10 sekúnd nezávisle na webserveri a pripojených klientoch, čo eliminuje potrebu udržiavať keep-alive spojenie.
Po vykonaní každej logiky termostat vypíše informáciu o aktuálnej IP adrese a prípadne aj mDNS zázname (v prípade, že je firmware konfigurovaný s mDNS podporou). Týmto spôsobom poskytuje používateľovi údaje o dostupnosti termostatu so svojím webovým rozhraním v rámci LAN siete.
Termostat navyše informuje o aktuálnom stave výstupu, vrátane oznamu o akýchkoľvek zmenách. Dynamická voľná pamäť (HEAP) termostatu sa pohybuje v rozmedzí 40 až 44 kB.
<b>Výstupná 3,3V operačná logika GPIO mikrokontrolérov ESP8266 a ESP32 postačuje pre digitálny signál zmeny. Je však dôležité mať na pamäti, že relé musí byť napájané 5V z VUSB alebo VIN pre správne fungovanie.</b>
</p>
<b>Webové rozhranie pre WiFi termostat umožňuje:</b>
<li>Prehliadať v reálnom čase teplotu zo senzora DS18B20, uptime zariadenia, hodnotu výstupu s dynamickou zmenou, aktuálne nastavené konfiguračné údaje pre termostat t.j. cieľovú teplotu a hysterézu</li>
<li>Modifikovať cieľovú (referenčnú) teplotu <del>v rozsahu 5 až 50 °C s 0,25 °C krokom</del><img src="https://i.imgur.com/zMsp0cr.png" width="20px" height="20px" data-toggle="tooltip2" data-placement="right" title="Rozsah odobratý vo verzii 1.0.2 z dôvodu nepodpory desatinnej čiarky pre input type number na OS Android"></li>
<li>Modifikovať hysterézu <del>v rozsahu 0 až 10 °C s 0,25 °C krokom</del><img src="https://i.imgur.com/zMsp0cr.png" width="20px" height="20px" data-toggle="tooltip2" data-placement="right" title="Rozsah odobratý vo verzii 1.0.2 z dôvodu nepodpory desatinnej čiarky pre input type number na OS Android"></li>
<div class="alert alert-danger">
  <strong>Programová implementácia termostatu s automatickým i manuálnym režimom ovládania výstupu je experimentálna!</strong>
</div>
<b>ZAP/VYP regulácia kotla - automatický režim:</b> 
<li>Príklad ZAP/VYP regulácie vykurovania - <font color="red">VIZUALIZÁCIA NIE JE SÚČASŤOU PROJEKTU</font></li>	
<li>Kotol je aktívny po dobu dostiahnutia cieľovej teploty + hysterézy</li>
<li>Na vizualizácii teplôt vody je patrný tzv. dobeh vykurovania a následné chladnutie vody až do opätovnej aktivity vykurovania, kedy je nameraná teplota pod nastavenú cieľovú teplotu - hystérzu</li>		
<img src="https://i.imgur.com/IDWLuOr.png" style="display: block; max-width: 100%; height: auto;" alt="ZAP/VYP regulácia kotla s hysterézou" title="ZAP/VYP regulácia kotla s hysterézou">   
<p style="text-align: justify;">
<b>V základnej verzii nášho WiFi termostatu (bez mDNS záznamu) sme integrovali manuálny režim ovládania s možnosťou jednoduchého prepínania medzi manuálnym a automatickým režimom.</b> Webové rozhranie je flexibilné a prispôsobuje sa rôznym obrazovkám, či už ide o veľké monitory alebo malé mobilné zariadenia. Je plne responzívne, podporuje širokouhlé obrazovky s vysokým rozlíšením a zároveň je optimalizované pre používanie na mobilných zariadeniach.
Rozhranie využíva importované CSS štýly z Bootstrap frameworku, ktoré sú načítané z externého CDN servera pri otvorení stránky bežiacej na mikrokontroléri ESP. Týmto spôsobom minimalizujeme výkonové a pamäťové zaťaženie mikrokontroléra, zabezpečujúc rýchlu a efektívnu funkcionalitu webového rozhrania.
</p>
<center><img src="https://i.imgur.com/8shZ0K3.png" style="display: block; max-width: 100%; height: auto;" alt="WiFi termostat - webové rozhranie vizualizované v systéme Android - Chrome" title="WiFi termostat - webové rozhranie vizualizované v systéme Android - Chrome"></center>   		
<hr>
<p style="text-align: justify;">
Pre uchovanie nastavených hodnôt termostatu aj po výpadku napájania sme zvolili ukladanie do EEPROM pamäte ESP, ktorá je emulovaná vo flash pamäti. Táto voľba je nevyhnutná, keďže platforma neobsahuje fyzický EEPROM čip (pamäť).
V EEPROM pamäti sú uložené referenčná teplota na offsete 10 a hodnota hysterézy na offsete 100. Každá z týchto hodnôt využíva maximálne 5 bajtov v EEPROM pamäti, vrátane ukončovacieho znaku.
Dáta sa prepisujú iba pri odoslaní HTML formulára, čo minimalizuje záťaž na EEPROM pamäť a zabezpečuje maximálnu trvanlivosť. Prevádzka termostatu je šetrná k EEPROM pamäti.
Stav výstupu existuje výhradne v RAM pamäti, kde sa prepisuje pri každej zmene. Hodnota sa neukladá do emulovanej EEPROM pamäte vo flash pamäti, čo zabezpečuje efektívne a spoľahlivé fungovanie termostatu.
</p>
<hr>
<p style="text-align: justify;">
Pri prvom spustení zariadenia bez existujúcich údajov na EEPROM offsetoch automaticky dochádza k zápisu predvolených hodnôt, a to s referenčnou teplotou 20.25 °C a hysterézou 0.00 °C. Toto fail-safe riešenie umožňuje bezproblémový chod termostatu aj na mikrokontroléroch, ktoré nemajú žiadne predchádzajúce údaje v EEPROM pamäti.
Pre zápis do EEPROM pamäte používame funkciu EEPROM.put(), ktorá podporuje akýkoľvek dátový typ, a následné potvrdenie zápisu pomocou EEPROM.commit() na cieľový offset. Implementácia využíva dátový typ float() pre 32-bitové číslo, ktoré je uložené v EEPROM a korešponduje s referenčnou teplotou a hysterézou.
Webserver vykonáva obnovu celej HTML stránky každých 30 sekúnd prostredníctvom meta tagu Refresh. Zároveň vypisuje pomocou Javascriptu orientačný čas do ďalšieho obnovenia do HTML stránky. Pre zachovanie zmeny pre termostat je dôležité stihnúť ju zapísať do EEPROM pred obnovením stránky, inak sa input okná pre číselné vstupy do formulára resetujú.
Vzhľadom na to, že built-in knižnica Ethernet neumožňuje využitie asynchrónneho webservera (čo je možné pri mikrokontroléroch Espressif ESP8266 / ESP32), je nutné prepisovať celú stránku, pretože táto implementácia je 1:1 s pôvodným Ethernet termostatom.
</p>
<hr>
<p style="text-align: justify;">
Dynamický údaj, ktorý sa predovšetkým mení je aktuálna hodnota výstupu - <b><font color="#27AE60">Zapnutý</font></b> / <b><font color="red">Vypnutý</font></b>, ktorý informuje prevádzkovateľa o skutočnom stave výstupu spoločne aj s farebným označením. 
Vzhľadom na to, že logika systému operuje nezávisle na webserveri, môže dochádzať k odlišnému stavu výstupu pred refreshom oproti tomu, čo je aktuálne zobrazené v webaplikácii. Akákoľvek zmena výstupu je okamžite zaznamenaná, napríklad na UART monitore.
Na webovej stránke termostatu nájde používateľ aj informácie o uptime zariadenia, teda o tom, ako dlho zariadenie beží, vyjadrené v dňoch, hodinách, minútach a sekundách. <b>Termostat je špeciálne navrhnutý iba pre interiérové teploty nad 0°C</b>, a táto charakteristika sa odráža aj v logike systému.
Termostat ponúka možnosť nahradiť existujúci izbový termostat, prípadne dočasne zastúpiť ohrievač v akváriu/teráriu na udržiavanie konštantnej teploty. Je vynikajúcim riešením pre kontrolu a udržiavanie teploty vo vnútri prostredí.
</p>
<div class="alert alert-danger">
	<strong>Autor WiFi termostatu nezodpovedá za funkčnosť termostatu, prípadné poruchy kotla ani za úrazy spôsobené elektrickým prúdom v prípade neodbornej montáže termostatu do siete. Je nevyhnutné dodržiavať bezpečnostné pokyny a zabezpečiť profesionálnu inštaláciu pre optimálne a bezpečné využívanie termostatu.</strong>
</div>	
<b>Hlavná stránka pre modifikáciu cieľovej teploty a hysterézy - ukážka zapnutého:</b>
<div class="alert alert-info">
	<strong>Ukážkové dáta</strong>
	<li><b>Cieľová teplota:</b>  22.75 °C</li>
	<li><b>Hysteréza:</b>  0.25 °C</li>
	<li><b>Namerané dáta:</b>  22.49 °C</li>
	<li><b>Výstup:</b>  <font color="#27AE60">Zapnutý</font></li>
	<hr>
	<p style="text-align: justify;">
Termostat spúšťa vykurovanie pri teplote 22.49 °C a nižšej. Po dosiahnutí teploty 23.01 °C sa výstup vypne, signalizačné relé sa rozpojí a plynový kotol zastaví vykurovanie. Následne prebieha fáza dobehu vykurovania, ktorá prispieva k chladnutiu miestnosti, kde sa merania vykonávajú. Termostat sa opäť aktivuje až pri dosiahnutí teploty 22.49 °C alebo nižšej, spúšťajúc ďalší cyklus vykurovania podľa nastavených parametrov.
	</p>	
</div>

<b>Hlavná stránka pre modifikáciu cieľovej teploty a hysterézy:</b>
<img src="https://i.imgur.com/YX7W2Z8.png" style="display: block; max-width: 100%; height: auto;" alt="WiFi termostat - Hlavný prehľad s modifikáciou cieľovej teploty a hysterézy - Vypnutý" title="WiFi termostat - Hlavný prehľad s modifikáciou cieľovej teploty a hysterézy - Vypnutý">        			

<b>Priebeh spracovania zadaných údajov (presmerovanie používateľa):</b>
<img src="https://i.imgur.com/ZptC0UR.png" style="display: block; max-width: 100%; height: auto;" alt="WiFi termostat - spracovanie údajov z HTML formulára" title="WiFi termostat - spracovanie údajov z HTML formulára">        			

<b>JSON výstup webservera v prehliadači / klientovi cez websocket:</b>
<center><img src="https://i.imgur.com/iqxV12k.png" style="display: block; max-width: 100%; height: auto;" alt="WiFi termostat - JSON output" title="WiFi termostat - JSON output"></center>        		

<b>Výstup do UART monitoru - logika systému + nastavená IP adresa, mDNS záznam:</b>
<center>
<img src="https://i.imgur.com/f1mF6Fk.png" style="display: block; max-width: 100%; height: auto;" alt="WiFi termostat - UART - ESP8266 - mDNS záznam" title="WiFi termostat - UART - ESP8266 - mDNS záznam">
<img src="https://i.imgur.com/rAfC2iJ.png" style="display: block; max-width: 100%; height: auto;" alt="WiFi termostat - UART - ESP32 - výstup - ovládanie kotla" title="WiFi termostat - UART - ESP32 - výstup - ovládanie kotla">
</center>        		
<hr><center><h4 style="display: none;">Dostupné knižnice pre mikrokontroléry (ESP)</h4></center><hr>
<div class="alert alert-danger" style="display: none;">
	Archív knižnice (.zip) rozbaliť do <strong>C:/Používatelia/[Používateľ]/Dokumenty/Arduino/libraries</strong>
</div>
<div class="table-responsive" style="display: none;">   
<table class="table" style="border: 1px solid black;">
<thead>
<tr>
<th style="width: 25%">Názov knižnice</th>
<th style="width: 50%">Funkcia knižnice</th>
<th style="width: 25%">Stiahnuť</th>
</tr>
</thead>
<tbody>
<tr>
<td style="width: 25%"><b>Dallas</b></td>
<td style="width: 50%">
<p style="text-align: justify;">
Knižnica pre mikrokontroléry ESP8266 a ESP32.
Umožňuje komunikáciu so senzorom Dallas DS18B20 na OneWire zbernici. Možnosť komunikácie po normálnom, alebo parazitnom zapojení. 
</p>
</td>
<td style="width: 25%"><a href="https://minhaskamal.github.io/DownGit/#/home?url=https://github.com/martinius96/termostat-ethernet/tree/master/src/dallas" class="btn btn-success" role="button">Stiahnuť</a></td>
</tr>
<tr>
<td style="width: 25%"><b>WiFiManager</b></td>
<td style="width: 50%">
<p style="text-align: justify;">
Knižnica pre mikrokontroléry ESP8266 a ESP32.
Vytvára prístupový bod (AP) a Captive portal pre konfiguráciu WiFi termostatu na domácu WiFi sieť. 
</p>
</td>
<td style="width: 25%"><a href="https://minhaskamal.github.io/DownGit/#/home?url=https://github.com/martinius96/WiFi-termostat/tree/main/src/WiFiManager-0.16.0" class="btn btn-success" role="button">Stiahnuť</a></td>
</tr>
<tr>
<td style="width: 25%"><b>DNS Server</b></td>
<td style="width: 50%">
<p style="text-align: justify;">
Knižnica pre mikrokontróler ESP32. 
Vyžaduje sa pre správne fungovanie knižnice WiFiManager. 
</p>
</td>
<td style="width: 25%"><a href="https://minhaskamal.github.io/DownGit/#/home?url=https://github.com/martinius96/WiFi-termostat/tree/main/src/DNSServer---esp32-master" class="btn btn-success" role="button">Stiahnuť</a></td>
</tr>
</tbody>
</table>
</div>
<hr>
<h3 style="display: none;"><font color="#2ECC71">WiFi termostat - zdrojový kód - ESP8266</font></h3>
<pre style="background-color:#2ECC71; display: none;">
/*|----------------------------------------------------------|*/
/*|HTTP webserver - WiFi thermostat - ESP8266 + DS18B20      |*/
/*|AUTHOR: Martin Chlebovec                                  |*/
/*|EMAIL: martinius96@gmail.com                              |*/
/*|DONATE: paypal.me/chlebovec                               |*/
/*|----------------------------------------------------------|*/

#include &lt;ESP8266WiFi.h>
#include &lt;ESP8266WebServer.h>
#include &lt;WiFiManager.h>
ESP8266WebServer server(80);
#include &lt;DNSServer.h>
#include &lt;EEPROM.h>
#include &lt;OneWire.h>
#include &lt;DallasTemperature.h>

#define ONE_WIRE_BUS 5 //D1
OneWire oneWire(ONE_WIRE_BUS);
DallasTemperature sensorsA(&oneWire);
const int rele = 4; //D2
unsigned long cas = 0;
String stav = "VYP";
float teplota;
long day = 86400000; // 86400000 milliseconds in a day
long hour = 3600000; // 3600000 milliseconds in an hour
long minute = 60000; // 60000 milliseconds in a minute
long second =  1000; // 1000 milliseconds in a second
float rezim;
boolean isFloat(String tString) {
  String tBuf;
  boolean decPt = false;

  if (tString.charAt(0) == '+' || tString.charAt(0) == '-') tBuf = &tString[1];
  else tBuf = tString;

  for (int x = 0; x &lt; tBuf.length(); x++)
  {
    if (tBuf.charAt(x) == '.' || tBuf.charAt(x) == ',') {
      if (decPt) return false;
      else decPt = true;
    }
    else if (tBuf.charAt(x) &lt; '0' || tBuf.charAt(x) > '9') return false;
  }
  return true;
}

void writeString(char add, float data)
{
  EEPROM.put(add, (data * 1000));
  EEPROM.commit();
}


float read_String(char add)
{
  float payload = 0;
  float data = EEPROM.get(add, payload);
  return (data / 1000);
}

void handleRoot() {
  int days = millis() / day ;                                //number of days
  unsigned int hours = (millis() % day) / hour;                       //the remainder from days division (in milliseconds) divided by hours, this gives the full hours
  unsigned int minutes = ((millis() % day) % hour) / minute ;         //and so on...
  unsigned int seconds = (((millis() % day) % hour) % minute) / second;
  String stranka = F("&lt;!DOCTYPE html>");
  stranka += F("&lt;html>");
  stranka += F("&lt;head>");
  stranka += F("&lt;meta charset='utf-8'>");
  stranka += F("&lt;meta name='author' content='Martin Chlebovec'>");
  stranka += F("&lt;meta http-equiv='Refresh' content='30'; />");
  stranka += F("&lt;meta name='viewport' content='width=device-width, initial-scale=1'>");
  stranka += F("&lt;link rel='stylesheet' href='https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css'>");
  stranka += F("&lt;script type='text/javascript'> window.smartlook||(function(d) {"); 
  stranka += F("var o=smartlook=function(){ o.api.push(arguments)},h=d.getElementsByTagName('head')[0];");
  stranka += F("var c=d.createElement('script');o.api=new Array();c.async=true;c.type='text/javascript';");
  stranka += F("c.charset='utf-8';c.src='https://rec.smartlook.com/recorder.js';h.appendChild(c); })(document);"); 
  stranka += F("smartlook('init', '63ff3bf4db2f85029b19856425a4f2086533c9e6');"); 
  stranka += F("&lt;/script>");  
  stranka += F("&lt;script type='text/javascript'>");
  stranka += F("var timeleft = 30;");
  stranka += F("var downloadTimer = setInterval(function(){");
  stranka += F("if(timeleft &lt;= 0){");
  stranka += F("clearInterval(downloadTimer);");
  stranka += F("document.getElementById(\"countdown\").innerHTML = \"Reštart...\";");
  stranka += F("} else {");
  stranka += F("document.getElementById(\"countdown\").innerHTML = timeleft + \" sekúnd do reštartu\";");
  stranka += F("}");
  stranka += F("timeleft -= 1;");
  stranka += F("}, 1000);");
  stranka += F("&lt;/script>");
  stranka += F("&lt;title>WiFi termostat - ESP8266&lt;/title>");
  stranka += F("&lt;/head>");
  stranka += F("&lt;body>");
  stranka += F("&lt;center>&lt;h3>WiFi termostat - ESP8266:&lt;/h3>");
  if (rezim == 0.00) {
    stranka += F("&lt;form action='/action.html' method='post'>");
    stranka += "&lt;b>Referenčná teplota:&lt;/b>&lt;br>&lt;input type='text' id='fname' name='fname' min='5' max='50' step='0.25' value=" + String(read_String(10)) + ">&lt;br>";
    stranka += "&lt;b>Hysteréza:&lt;/b>&lt;br>&lt;input type='text' id='fname2' name='fname2' min='0' max='10' step='0.25' value=" + String(read_String(100)) + ">&lt;br>";
    stranka += F("&lt;input type='submit' class='btn btn-success' value='Zapísať'>");
    stranka += F("&lt;/form>");
    stranka += F("&lt;a href='manual.html' class='btn btn-primary' role='button'>Manuálny režim&lt;/a>&lt;hr>");
  } else if (rezim == 1.00) {
    if (stav == "ZAP") {
      stranka += F("&lt;a href='vyp.html' class='btn btn-danger' role='button'>Vypnúť&lt;/a>&lt;br>");
    }
    if (stav == "VYP") {
      stranka += F("&lt;a href='zap.html' class='btn btn-success' role='button'>Zapnúť&lt;/a>&lt;br>");
    }
    stranka += F("&lt;a href='automat.html' class='btn btn-primary' role='button'>Automatický režim&lt;/a>&lt;hr>");
  }
  if (stav == "ZAP") {
    stranka += F("&lt;b>&lt;font color='green'>Výstup: Zapnutý&lt;/font>&lt;/b>");
  }
  if (stav == "VYP") {
    stranka += F("&lt;b>&lt;font color='red'>Výstup: Vypnutý&lt;/font>&lt;/b>");
  }
  stranka += F("&lt;div id=\"countdown\">&lt;/div>");
  stranka += F("&lt;b>Aktuálna teplota senzora DS18B20:&lt;/b> ");
  stranka += String(teplota);
  stranka += F(" °C");
  stranka += F("&lt;hr>");
  stranka += F("&lt;b>Uptime: &lt;/b>");
  stranka += String(days);
  stranka += F("d");
  stranka += F(" ");
  stranka += String(hours);
  stranka += F("h");
  stranka += F(" ");
  stranka += String(minutes);
  stranka += F("m");
  stranka += F(" ");
  stranka += String(seconds);
  stranka += F("s");
  stranka += F("&lt;h3>Autor: Martin Chlebovec - martinius96@gmail.com - https://martinius96.github.io/WiFi-termostat/&lt;/h3>");
  stranka += F("&lt;h4>Verzia free - 1.0.3 build: 22. Jan. 2021&lt;/h4>");
  stranka += F("&lt;/center>");
  stranka += F("&lt;div class='alert alert-info'>");
  stranka += F("Finálny build projektu WiFi termostat. Ďakujem za vyskúšanie webaplikácie. Rozšírené verzie projektu sú platené.&lt;br>&lt;strong>Obsah platených verzií:&lt;/strong>&lt;li>Async Webserver - AJAX update&lt;/li>&lt;li>Manuálny režim&lt;/li>&lt;li>OTA aktualizácie&lt;/li>&lt;li>Ovládanie hlasom cez Amazon Alexa&lt;/li>&lt;li>Ovládanie cez UDP callbacky&lt;/li>&lt;li>Možnosť publikácie dát na MQTT Broker (Loxone, IoT Industries Slovakia, Blynk...),&lt;/li>&lt;li>Dostupné senzory Bosch, Sensirion, DHT&lt;/li>&lt;li>Watchdog Timer&lt;/li>&lt;li>Zdrojový kód (.ino) pre aplikáciu.&lt;/li>&lt;li>Auto-test periférii, fail-safe riešenie&lt;/li>&lt;li>JSON output rozšírený o systémové dáta (WiFi sieť, RSSI, uptime, napájacie napätie...)&lt;/li>");
  stranka += F("&lt;/div>");
  stranka += F("&lt;/body>");
  stranka += F("&lt;/html>");
  server.send(200, "text/html", stranka);
}

void handleBody() {
  if (server.hasArg("fname")) {
    String target_temp = server.arg("fname");
    // float cielova_teplota = target_temp.toFloat();

    if (isFloat(target_temp)) {
      float cielova_teplota = target_temp.toFloat();
      writeString(10, cielova_teplota);
    } else {
      Serial.println(F("Do input pola cielovej teploty nebolo vlozene cislo!"));
      Serial.println(F("Zapis zakazany!"));
    }
  }
  if (server.hasArg("fname2")) {
    String hysteresis = server.arg("fname2");
    if (isFloat(hysteresis)) {
      float hystereza = hysteresis.toFloat();
      writeString(100, hystereza);
    } else {
      Serial.println(F("Do input pola hysterezy nebolo vlozene cislo!"));
      Serial.println(F("Zapis zakazany!"));
    }
  }
  String stranka = F("&lt;!DOCTYPE html>");
  stranka += F("&lt;html>");
  stranka += F("&lt;head>");
  stranka += F("&lt;meta charset='utf-8'>");
  stranka += F("&lt;meta http-equiv='Refresh' content='5; url=/' />");
  stranka += F("&lt;title>WiFi termostat - ESP8266 - spracovanie riadiach dát&lt;/title>");
  stranka += F("&lt;/head>");
  stranka += F("&lt;body>");
  stranka += F("&lt;center>&lt;h3>Server prijal data z formulára:&lt;/h3>");
  stranka += "&lt;li>&lt;b>Referenčná teplota: &lt;/b>" + String(read_String(10)) + " °C&lt;/li>";
  stranka += "&lt;li>&lt;b>Hysteréza: &lt;/b>" + String(read_String(100)) + " °C&lt;/li>";
  stranka += F("&lt;b>Presmerovanie... Prosím čakajte&lt;/b>&lt;/center>");
  stranka += F("&lt;/body>");
  stranka += F("&lt;/html>");
  server.send(200, "text/html", stranka);
}

void handleGet() {
  String stranka = "{\n";
  stranka += F("\"Hysteresis\":");
  stranka += String(read_String(100));
  stranka += F(",\n");
  stranka += F("\"Target_Temperature\":");
  stranka += String(read_String(10));
  stranka += F(",\n");
  stranka += F("\"Actual_Temperature\":");
  stranka += String(teplota) + "\n";
  stranka += F("}\n");
  server.send(200, "application/json", stranka);
}

void handleZAP() {
  stav = "ZAP";
  digitalWrite(rele, LOW);
  String stranka = F("&lt;!DOCTYPE html>");
  stranka += F("&lt;html>");
  stranka += F("&lt;head>");
  stranka += F("&lt;meta charset='utf-8'>");
  stranka += F("&lt;meta http-equiv='Refresh' content='0; url=/' />");
  stranka += F("&lt;/head>");
  stranka += F("&lt;/html>");
  server.send(200, "text/html", stranka);
}

void handleAuto() {
  writeString(150, 0.00);
  rezim = read_String(150);
  String stranka = F("&lt;!DOCTYPE html>");
  stranka += F("&lt;html>");
  stranka += F("&lt;head>");
  stranka += F("&lt;meta charset='utf-8'>");
  stranka += F("&lt;meta http-equiv='Refresh' content='0; url=/' />");
  stranka += F("&lt;/head>");
  stranka += F("&lt;/html>");
  server.send(200, "text/html", stranka);
}
void handleManual() {
  writeString(150, 1.00);
  rezim = read_String(150);
  String stranka = F("&lt;!DOCTYPE html>");
  stranka += F("&lt;html>");
  stranka += F("&lt;head>");
  stranka += F("&lt;meta charset='utf-8'>");
  stranka += F("&lt;meta http-equiv='Refresh' content='0; url=/' />");
  stranka += F("&lt;/head>");
  stranka += F("&lt;/html>");
  server.send(200, "text/html", stranka);
}
void handleVYP() {
  stav = "VYP";
  digitalWrite(rele, HIGH);
  String stranka = F("&lt;!DOCTYPE html>");
  stranka += F("&lt;html>");
  stranka += F("&lt;head>");
  stranka += F("&lt;meta charset='utf-8'>");
  stranka += F("&lt;meta http-equiv='Refresh' content='0; url=/' />");
  stranka += F("&lt;/head>");
  stranka += F("&lt;/html>");
  server.send(200, "text/html", stranka);
}
void setup() {
  Serial.begin(115200);
  WiFiManager wifiManager;
  wifiManager.autoConnect("WiFi_TERMOSTAT_AP");
  EEPROM.begin(512);  //Initialize EEPROM
  float a = read_String(10);
  float b = read_String(100);
  float c = read_String(150);
  if (isnan(a)) {
    writeString(10, 20.25);
  }
  if (isnan(b)) {
    writeString(100, 0.25);
  }
  if (isnan(c)) {
    writeString(150, 0.00);
  }
  sensorsA.begin();
  pinMode(rele, OUTPUT);
  digitalWrite(rele, HIGH);
  sensorsA.requestTemperatures();
  delay(750);
  Serial.println(F("WiFi termostat - Author: Martin Chlebovec"));
  Serial.println("");
  Serial.println(F("WiFi connected."));
  Serial.println(F("IP address: "));
  Serial.println(WiFi.localIP());
  server.on("/", handleRoot);
  server.on("/get_data.json", handleGet);
  server.on("/automat.html", handleAuto);
  server.on("/manual.html", handleManual);
  server.on("/zap.html", handleZAP);
  server.on("/vyp.html", handleVYP);
  server.on("/action.html", HTTP_POST, handleBody);
  server.begin();
}

void loop() {
  if ((millis() - cas) >= 10000 || cas == 0) {
    cas = millis();
    teplota = sensorsA.getTempCByIndex(0);
    Serial.println();
    Serial.println(F("----------------------------------------------"));
    Serial.print(F("IP addresa ESP8266 termostat: "));
    Serial.print(WiFi.localIP());
    Serial.print(F(", pre pristup k termostatu navstivte http://"));
    Serial.print(WiFi.localIP());
    Serial.println(F("/"));
    Serial.print(F("Free HEAP: "));
    Serial.print(ESP.getFreeHeap());
    Serial.println(F(" B"));
    Serial.print(F("Aktuálna teplota: "));
    Serial.print(String(teplota));
    Serial.println(F(" °C"));
    sensorsA.requestTemperatures();
    rezim = read_String(150);
    if (rezim == 0.00) {
      float cielova_teplota = read_String(10);
      float  hystereza = read_String(100);
      float minus_hystereza_teplota = (-1 * hystereza);
      float rozdiel = cielova_teplota - teplota; //21 - 20
      if (rozdiel > hystereza) {
        Serial.println(F("Kotol zapnuty"));
        stav = "ZAP";
        digitalWrite(rele, LOW);
      } else if (rozdiel &lt; minus_hystereza_teplota) {
        Serial.println(F("Kotol vypnuty"));
        stav = "VYP";
        digitalWrite(rele, HIGH);
      } else {
        Serial.println(F("Rozdiel cielovej a aktuálnej teploty nie je nad, ani pod hysterezou. Stav vystupu sa nemeni."));
        Serial.print(F("Aktualny stav vystupu pre kotol: "));
        Serial.println(stav);
      }
    } else {
      Serial.print(F("Manualny rezim, stav vystupu: "));
      Serial.println(stav);
    }
  }
  server.handleClient();
  yield();
}
</pre>
<h3 style="display: none;"><font color="#3498DB">WiFi termostat - zdrojový kód - ESP32</font></h3>
<pre style="background-color:#3498DB; display:none;">
/*|----------------------------------------------------------|*/
/*|HTTP webserver - WiFi thermostat - ESP32 + DS18B20        |*/
/*|AUTHOR: Martin Chlebovec                                  |*/
/*|EMAIL: martinius96@gmail.com                              |*/
/*|DONATE: paypal.me/chlebovec                               |*/
/*|----------------------------------------------------------|*/

#include &lt;WiFi.h>
#include &lt;WebServer.h>
#include &lt;WiFiManager.h>
WebServer server(80);

#include &lt;EEPROM.h>
#include &lt;OneWire.h>
#include &lt;DallasTemperature.h>

#define ONE_WIRE_BUS 23 //D1
OneWire oneWire(ONE_WIRE_BUS);
DallasTemperature sensorsA(&oneWire);
const int rele = 22; //D2
unsigned long cas = 0;
String stav = "VYP";
float teplota;
long day = 86400000; // 86400000 milliseconds in a day
long hour = 3600000; // 3600000 milliseconds in an hour
long minute = 60000; // 60000 milliseconds in a minute
long second =  1000; // 1000 milliseconds in a second
float rezim;
boolean isFloat(String tString) {
  String tBuf;
  boolean decPt = false;

  if (tString.charAt(0) == '+' || tString.charAt(0) == '-') tBuf = &tString[1];
  else tBuf = tString;

  for (int x = 0; x &lt; tBuf.length(); x++)
  {
    if (tBuf.charAt(x) == '.' || tBuf.charAt(x) == ',') {
      if (decPt) return false;
      else decPt = true;
    }
    else if (tBuf.charAt(x) &lt; '0' || tBuf.charAt(x) > '9') return false;
  }
  return true;
}

void writeString(char add, float data)
{
  EEPROM.put(add, (data * 1000));
  EEPROM.commit();
}


float read_String(char add)
{
  float payload = 0;
  float data = EEPROM.get(add, payload);
  return (data / 1000);
}

void handleRoot() {
  int days = millis() / day ;                                //number of days
  unsigned int hours = (millis() % day) / hour;                       //the remainder from days division (in milliseconds) divided by hours, this gives the full hours
  unsigned int minutes = ((millis() % day) % hour) / minute ;         //and so on...
  unsigned int seconds = (((millis() % day) % hour) % minute) / second;
  String stranka = F("&lt;!DOCTYPE html>");
  stranka += F("&lt;html>");
  stranka += F("&lt;head>");
  stranka += F("&lt;meta charset='utf-8'>");
  stranka += F("&lt;meta name='author' content='Martin Chlebovec'>");
  stranka += F("&lt;meta http-equiv='Refresh' content='30'; />");
  stranka += F("&lt;meta name='viewport' content='width=device-width, initial-scale=1'>");
  stranka += F("&lt;link rel='stylesheet' href='https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css'>");
  stranka += F("&lt;script type='text/javascript'> window.smartlook||(function(d) {"); 
  stranka += F("var o=smartlook=function(){ o.api.push(arguments)},h=d.getElementsByTagName('head')[0];");
  stranka += F("var c=d.createElement('script');o.api=new Array();c.async=true;c.type='text/javascript';");
  stranka += F("c.charset='utf-8';c.src='https://rec.smartlook.com/recorder.js';h.appendChild(c); })(document);"); 
  stranka += F("smartlook('init', '63ff3bf4db2f85029b19856425a4f2086533c9e6');"); 
  stranka += F("&lt;/script>");  
  stranka += F("&lt;script type='text/javascript'>");
  stranka += F("var timeleft = 30;");
  stranka += F("var downloadTimer = setInterval(function(){");
  stranka += F("if(timeleft &lt;= 0){");
  stranka += F("clearInterval(downloadTimer);");
  stranka += F("document.getElementById(\"countdown\").innerHTML = \"Reštart...\";");
  stranka += F("} else {");
  stranka += F("document.getElementById(\"countdown\").innerHTML = timeleft + \" sekúnd do reštartu\";");
  stranka += F("}");
  stranka += F("timeleft -= 1;");
  stranka += F("}, 1000);");
  stranka += F("&lt;/script>");
  stranka += F("&lt;title>WiFi termostat - ESP32&lt;/title>");
  stranka += F("&lt;/head>");
  stranka += F("&lt;body>");
  stranka += F("&lt;center>&lt;h3>WiFi termostat - ESP32:&lt;/h3>");
  if (rezim == 0.00) {
    stranka += F("&lt;form action='/action.html' method='post'>");
    stranka += "&lt;b>Referenčná teplota:&lt;/b>&lt;br>&lt;input type='text' id='fname' name='fname' min='5' max='50' step='0.25' value=" + String(read_String(10)) + ">&lt;br>";
    stranka += "&lt;b>Hysteréza:&lt;/b>&lt;br>&lt;input type='text' id='fname2' name='fname2' min='0' max='10' step='0.25' value=" + String(read_String(100)) + ">&lt;br>";
    stranka += F("&lt;input type='submit' class='btn btn-success' value='Zapísať'>");
    stranka += F("&lt;/form>");
    stranka += F("&lt;a href='manual.html' class='btn btn-primary' role='button'>Manuálny režim&lt;/a>&lt;hr>");
  } else if (rezim == 1.00) {
    if (stav == "ZAP") {
      stranka += F("&lt;a href='vyp.html' class='btn btn-danger' role='button'>Vypnúť&lt;/a>&lt;br>");
    }
    if (stav == "VYP") {
      stranka += F("&lt;a href='zap.html' class='btn btn-success' role='button'>Zapnúť&lt;/a>&lt;br>");
    }
    stranka += F("&lt;a href='automat.html' class='btn btn-primary' role='button'>Automatický režim&lt;/a>&lt;hr>");
  }
  if (stav == "ZAP") {
    stranka += F("&lt;b>&lt;font color='green'>Výstup: Zapnutý&lt;/font>&lt;/b>");
  }
  if (stav == "VYP") {
    stranka += F("&lt;b>&lt;font color='red'>Výstup: Vypnutý&lt;/font>&lt;/b>");
  }
  stranka += F("&lt;div id=\"countdown\">&lt;/div>");
  stranka += F("&lt;b>Aktuálna teplota senzora DS18B20:&lt;/b> ");
  stranka += String(teplota);
  stranka += F(" °C");
  stranka += F("&lt;hr>");
  stranka += F("&lt;b>Uptime: &lt;/b>");
  stranka += String(days);
  stranka += F("d");
  stranka += F(" ");
  stranka += String(hours);
  stranka += F("h");
  stranka += F(" ");
  stranka += String(minutes);
  stranka += F("m");
  stranka += F(" ");
  stranka += String(seconds);
  stranka += F("s");
  stranka += F("&lt;h3>Autor: Martin Chlebovec - martinius96@gmail.com - https://martinius96.github.io/WiFi-termostat/&lt;/h3>");
  stranka += F("&lt;h4>Verzia free - 1.0.3 build: 22. Jan. 2021&lt;/h4>");
  stranka += F("&lt;/center>");
  stranka += F("&lt;div class='alert alert-info'>");
  stranka += F("Finálny build projektu WiFi termostat. Ďakujem za vyskúšanie webaplikácie. Rozšírené verzie projektu sú platené.&lt;br>&lt;strong>Obsah platených verzií:&lt;/strong>&lt;li>Async Webserver - AJAX update&lt;/li>&lt;li>Manuálny režim&lt;/li>&lt;li>OTA aktualizácie&lt;/li>&lt;li>Ovládanie hlasom cez Amazon Alexa&lt;/li>&lt;li>Ovládanie cez UDP callbacky&lt;/li>&lt;li>Možnosť publikácie dát na MQTT Broker (Loxone, IoT Industries Slovakia, Blynk...),&lt;/li>&lt;li>Dostupné senzory Bosch, Sensirion, DHT&lt;/li>&lt;li>Watchdog Timer&lt;/li>&lt;li>Zdrojový kód (.ino) pre aplikáciu.&lt;/li>&lt;li>Auto-test periférii, fail-safe riešenie&lt;/li>&lt;li>JSON output rozšírený o systémové dáta (WiFi sieť, RSSI, uptime, napájacie napätie...)&lt;/li>");
  stranka += F("&lt;/div>");
  stranka += F("&lt;/body>");
  stranka += F("&lt;/html>");
  server.send(200, "text/html", stranka);
}

void handleBody() {
  if (server.hasArg("fname")) {
    String target_temp = server.arg("fname");
    // float cielova_teplota = target_temp.toFloat();

    if (isFloat(target_temp)) {
      float cielova_teplota = target_temp.toFloat();
      writeString(10, cielova_teplota);
    } else {
      Serial.println(F("Do input pola cielovej teploty nebolo vlozene cislo!"));
      Serial.println(F("Zapis zakazany!"));
    }
  }
  if (server.hasArg("fname2")) {
    String hysteresis = server.arg("fname2");
    if (isFloat(hysteresis)) {
      float hystereza = hysteresis.toFloat();
      writeString(100, hystereza);
    } else {
      Serial.println(F("Do input pola hysterezy nebolo vlozene cislo!"));
      Serial.println(F("Zapis zakazany!"));
    }
  }
  String stranka = F("&lt;!DOCTYPE html>");
  stranka += F("&lt;html>");
  stranka += F("&lt;head>");
  stranka += F("&lt;meta charset='utf-8'>");
  stranka += F("&lt;meta http-equiv='Refresh' content='5; url=/' />");
  stranka += F("&lt;title>WiFi termostat - ESP32 - spracovanie riadiach dát&lt;/title>");
  stranka += F("&lt;/head>");
  stranka += F("&lt;body>");
  stranka += F("&lt;center>&lt;h3>Server prijal data z formulára:&lt;/h3>");
  stranka += "&lt;li>&lt;b>Referenčná teplota: &lt;/b>" + String(read_String(10)) + " °C&lt;/li>";
  stranka += "&lt;li>&lt;b>Hysteréza: &lt;/b>" + String(read_String(100)) + " °C&lt;/li>";
  stranka += F("&lt;b>Presmerovanie... Prosím čakajte&lt;/b>&lt;/center>");
  stranka += F("&lt;/body>");
  stranka += F("&lt;/html>");
  server.send(200, "text/html", stranka);
}

void handleGet() {
  String stranka = "{\n";
  stranka += F("\"Hysteresis\":");
  stranka += String(read_String(100));
  stranka += F(",\n");
  stranka += F("\"Target_Temperature\":");
  stranka += String(read_String(10));
  stranka += F(",\n");
  stranka += F("\"Actual_Temperature\":");
  stranka += String(teplota) + "\n";
  stranka += F("}\n");
  server.send(200, "application/json", stranka);
}

void handleZAP() {
  stav = "ZAP";
  digitalWrite(rele, LOW);
  String stranka = F("&lt;!DOCTYPE html>");
  stranka += F("&lt;html>");
  stranka += F("&lt;head>");
  stranka += F("&lt;meta charset='utf-8'>");
  stranka += F("&lt;meta http-equiv='Refresh' content='0; url=/' />");
  stranka += F("&lt;/head>");
  stranka += F("&lt;/html>");
  server.send(200, "text/html", stranka);
}

void handleAuto() {
  writeString(150, 0.00);
  rezim = read_String(150);
  String stranka = F("&lt;!DOCTYPE html>");
  stranka += F("&lt;html>");
  stranka += F("&lt;head>");
  stranka += F("&lt;meta charset='utf-8'>");
  stranka += F("&lt;meta http-equiv='Refresh' content='0; url=/' />");
  stranka += F("&lt;/head>");
  stranka += F("&lt;/html>");
  server.send(200, "text/html", stranka);
}
void handleManual() {
  writeString(150, 1.00);
  rezim = read_String(150);
  String stranka = F("&lt;!DOCTYPE html>");
  stranka += F("&lt;html>");
  stranka += F("&lt;head>");
  stranka += F("&lt;meta charset='utf-8'>");
  stranka += F("&lt;meta http-equiv='Refresh' content='0; url=/' />");
  stranka += F("&lt;/head>");
  stranka += F("&lt;/html>");
  server.send(200, "text/html", stranka);
}
void handleVYP() {
  stav = "VYP";
  digitalWrite(rele, HIGH);
  String stranka = F("&lt;!DOCTYPE html>");
  stranka += F("&lt;html>");
  stranka += F("&lt;head>");
  stranka += F("&lt;meta charset='utf-8'>");
  stranka += F("&lt;meta http-equiv='Refresh' content='0; url=/' />");
  stranka += F("&lt;/head>");
  stranka += F("&lt;/html>");
  server.send(200, "text/html", stranka);
}
void setup() {
  Serial.begin(115200);
  WiFiManager wifiManager;
  wifiManager.autoConnect("WiFi_TERMOSTAT_AP");
  EEPROM.begin(512);  //Initialize EEPROM
  float a = read_String(10);
  float b = read_String(100);
  float c = read_String(150);
  if (isnan(a)) {
    writeString(10, 20.25);
  }
  if (isnan(b)) {
    writeString(100, 0.25);
  }
  if (isnan(c)) {
    writeString(150, 0.00);
  }
  sensorsA.begin();
  pinMode(rele, OUTPUT);
  digitalWrite(rele, HIGH);
  sensorsA.requestTemperatures();
  delay(750);
  Serial.println(F("WiFi termostat - Author: Martin Chlebovec"));
  Serial.println("");
  Serial.println(F("WiFi connected."));
  Serial.println(F("IP address: "));
  Serial.println(WiFi.localIP());
  server.on("/", handleRoot);
  server.on("/get_data.json", handleGet);
  server.on("/automat.html", handleAuto);
  server.on("/manual.html", handleManual);
  server.on("/zap.html", handleZAP);
  server.on("/vyp.html", handleVYP);
  server.on("/action.html", HTTP_POST, handleBody);
  server.begin();
}

void loop() {
  if ((millis() - cas) >= 10000 || cas == 0) {
    cas = millis();
    teplota = sensorsA.getTempCByIndex(0);
    Serial.println();
    Serial.println(F("----------------------------------------------"));
    Serial.print(F("IP addresa ESP32 termostat: "));
    Serial.print(WiFi.localIP());
    Serial.print(F(", pre pristup k termostatu navstivte http://"));
    Serial.print(WiFi.localIP());
    Serial.println(F("/"));
    Serial.print(F("Free HEAP: "));
    Serial.print(ESP.getFreeHeap());
    Serial.println(F(" B"));
    Serial.print(F("Aktuálna teplota: "));
    Serial.print(String(teplota));
    Serial.println(F(" °C"));
    sensorsA.requestTemperatures();
    rezim = read_String(150);
    if (rezim == 0.00) {
      float cielova_teplota = read_String(10);
      float  hystereza = read_String(100);
      float minus_hystereza_teplota = (-1 * hystereza);
      float rozdiel = cielova_teplota - teplota; //21 - 20
      if (rozdiel > hystereza) {
        Serial.println(F("Kotol zapnuty"));
        stav = "ZAP";
        digitalWrite(rele, LOW);
      } else if (rozdiel &lt; minus_hystereza_teplota) {
        Serial.println(F("Kotol vypnuty"));
        stav = "VYP";
        digitalWrite(rele, HIGH);
      } else {
        Serial.println(F("Rozdiel cielovej a aktuálnej teploty nie je nad, ani pod hysterezou. Stav vystupu sa nemeni."));
        Serial.print(F("Aktualny stav vystupu pre kotol: "));
        Serial.println(stav);
      }
    } else {
      Serial.print(F("Manualny rezim, stav vystupu: "));
      Serial.println(stav);
    }
  }
  server.handleClient();
  yield();
}
</pre>
</div>
</div>
</body>
        <script>
$(document).ready(function(){
  $('[data-toggle="tooltip2"]').tooltip();   
});
</script>
</html>
