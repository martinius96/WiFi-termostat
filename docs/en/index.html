<!DOCTYPE html>
<html lang="en">
<head>
	<!-- Primary Meta Tags -->
	<title>WiFi thermostat - ESP8266 / ESP32 - Webserver - boiler control with hysteresis</title>
	<meta name="description" content="Room thermostat designed on the Espressif platform - ESP8266 / ESP32. Thermostat for domestic heating with gas boiler control.">
	<meta name="keywords" content="Thermostat, digital, arduino ide, wemos d1 mini, nodemcu, wifi, esp8266, heating, wifimanager, webserver, socket, http, web, ip, ipv4, ds18b20, onewire, 1-wire, esp32, nodemcu">
	<!-- Open Graph / Facebook -->
	<meta property="og:type" content="website">
	<meta property="og:url" content="https://martinius96.github.io/WiFi-termostat/en/">
	<meta property="og:title" content="WiFi thermostat - ESP8266 / ESP32 - Webserver - boiler control with hysteresis">
	<meta property="og:description" content="Room thermostat designed on the Espressif platform - ESP8266 / ESP32. Thermostat for domestic heating with gas boiler control.">

	<!-- Twitter -->
	<meta property="twitter:card" content="summary_large_image">
	<meta property="twitter:url" content="https://martinius96.github.io/WiFi-termostat/en/">
	<meta property="twitter:title" content="WiFi thermostat - ESP8266 / ESP32 - Webserver - boiler control with hysteresis">
	<meta property="twitter:description" content="Room thermostat designed on the Espressif platform - ESP8266 / ESP32. Thermostat for domestic heating with gas boiler control">
	
	<link rel="icon" type="image/png" href="favicon.png">
	<link rel="sitemap" type="application/xml" title="Sitemap" href="../../sitemap.xml" />
	<meta name="google-site-verification" content="UwZZh2EXv3iWUAi_1Z0hLxVCz6ySJ4UdY_BPoLtejwo" />    	
	<meta property='fb:admins' content='100001242570317'>
    	<meta charset="utf-8">
    	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
	<script type="text/javascript">
    		window.smartlook||(function(d) {
    			var o=smartlook=function(){ o.api.push(arguments)},h=d.getElementsByTagName('head')[0];
    			var c=d.createElement('script');o.api=new Array();c.async=true;c.type='text/javascript';
    			c.charset='utf-8';c.src='https://rec.smartlook.com/recorder.js';h.appendChild(c);
    		})(document);
    		smartlook('init', 'db50efe9fff280a17db52b82be221240cbbd3dbe');
	</script>    
		<style>
	#right {
  position: absolute;
  right: 0px;
}
	</style>
</head>
<body>
	<div class="container">
  		<div class="row">
    			<div class="col-sm-12">
<nav class="navbar navbar-inverse">
  <div class="container-fluid">
    <div class="navbar-header">
      <a class="navbar-brand" href="index.html">WiFi thermostat</a>
    </div>
    <ul class="nav navbar-nav">
      	<li class="active"><a href="index.html">Overview</a></li>
	<li><a href="zapojenie.html">Involvement</a></li>      
	<li class=""><a href="spustenie.html">Firmware</a></li>
  	<li><a href="json_client.html">JSON client</a></li>
      	<li><a href="kontakt.html">Contact</a></li>
<a href="../de/index.html"><img src="https://futbalovysen.sk/wp-content/uploads/germany.png" alt="Germany.png, 2,2kB" title="Germany" height="32" width="32"></a>	
<a href="../index.html"><img src="https://futbalovysen.sk/wp-content/uploads/slovakia.png" alt="Slovak flag.png, 2,2kB" title="Slovakia" height="32" width="32"></a>   
<li style="float: right; "><a href="https://martinius96.github.io/termostat-ethernet/en/" class="btn btn-danger" role="button" title="Zmeniť projekt na Ethernet termostat"><img src="https://i.imgur.com/6dW9TvK.png" width=16px height=16px> <font color="white">Ethernet thermostat</font></a></li>
</ul>
  </div>
</nav>  
<div class="alert alert-success">
	<strong>Project repository with machine codes: </strong><a href="https://github.com/martinius96/WiFi-termostat/">WiFi thermostat - the latest release compiled from the latest build of Arduino Core 2.7.4.</a>
</div>	
<div class="alert alert-danger">
	The WiFi_Thermostat and WiFi_Thermostat_mDNS firmware is available in English language for the ESP32 and ESP8266 microcontrollers (Espressif Systems). Experimental version of basic Thermostat firmware with manual output control is only available in the Slovak language.
</div>	
<div class="alert alert-info">
 	<strong>Support the WiFi thermostat project via PayPal. Support will allow you to add new features in the future and open the source code of the application: </strong><a href="https://www.paypal.com/paypalme/chlebovec" class="btn btn-primary" role="button">PayPal donate</a>
</div>	
<span class="label label-default">ESP8266</span>
<span class="label label-primary">ESP32</span>
<span class="label label-success">WiFi</span>
<span class="label label-info">DS18B20</span>
<span class="label label-warning">OneWire</span>
<span class="label label-danger">Dallas</span>
<span class="label label-default">HTML</span>
<span class="label label-primary">Webserver</span>
<span class="label label-success">WebSocket</span>
<span class="label label-info">JSON</span>
<span class="label label-warning">mDNS</span>	
<span class="label label-danger">UART</span>					
  <div class="row">
	<div class="col-sm-4"><center><img src="https://i.imgur.com/koSyFuW.png" width="128px" height="128px" style="border-radius: 50%;" alt="Control microcontroller NodeMCU v2 / v3 Lolin - ESP8266-12E / ESP8266-12F" title="Control microcontroller NodeMCU v2 / v3 Lolin - ESP8266-12E / ESP8266-12F"><br><b><a href="https://www.ebay.com/itm/252718027546">NodeMCU (ESP8266)</a></b></center></div>
	<div class="col-sm-4"><center><img src="https://i.imgur.com/FV9xi6K.png" width="128px" height="128px" style="border-radius: 50%;" alt="Control microcontroller Wemos D1 Mini - ESP8266-12E / ESP8266-12F" title="Control microcontroller Wemos D1 Mini - ESP8266-12E / ESP8266-12F"><br><b><a href="https://www.ebay.com/itm/254535886946">Wemos D1 / D1 Mini (ESP8266)</a></b></center></div>
	<div class="col-sm-4"><center><img src="https://i.imgur.com/BczG03b.png" width="128px" height="128px" style="border-radius: 50%;" alt="Control microcontroller ESP32 Devkit V1 - ESP-WROOM-32 / ESP32-S" title="Control microcontroller ESP32 Devkit V1 - ESP-WROOM-32 / ESP32-S"><br><b><a href="https://www.ebay.com/itm/254953129496">ESP32 DevKit</a></b></center></div></div>					
<hr><center><h2>WiFi thermostat - ESP8266 / ESP32</h2></center><hr>
<p style="text-align: justify;">
The software implementation is designed for microcontroller platforms from the manufacturer Espressif Systems with WiFi connectivity.
Specifically, the ESP8266 microcontroller in versions 12E to F used in the Wemos D1 Mini, NodeMCU v2, v3 platforms.
<b> ESP8266-01 / ESP8266-01S microcontrollers and similar standalone chips before the 12E generation are not compatible for the project in terms of program recording, as they do not use the DIO flash method, for which ESPTOOL calls are designed in the project; upload firmware to these devices as well. </b>
For the ESP32 microcontroller, it is possible to use standalone chips ESP32-WROOM-32 from Espressif and the equivalent ESP-32S from AI-Thinker.
All DevKits included with these chips are also compatible, they are fully compatible (for example DevKit v1 / DevKiTC-v4).
WiFi thermostat is accessible from the LAN network in which it is located, while it is equipped with a web interface that is used to configure all elements of the thermostat.
The thermostat controls the boiler based on the measured, target temperature and hysteresis independently of the web application, which serves for the configuration and decision threshold of the thermostat.
In addition to the availability of the thermostat at a specific IP address, the thermostat can be supplemented with an mDNS record, which generates a local domain (hostname.local) accessible only in the LAN network within this multicast service.
The configuration of the thermostat (from the point of view of connectivity) on the home WiFi LAN network is secured by WiFiManager, which stores data about the WiFi network (SSID and password) in the flash memory of the microcontroller.
The storage is one-time and the device remembers the configuration permanently. After gaining connectivity (assigning an IP address from the router of your home WiFi network), the thermostat can be fully used.
The HTTP web server running on the ESP8266 / ESP32 microcontroller allows the running of several independent HTML pages, which can be informative or even functional.
</p>
<b>In terms of hardware, the project uses:</b>
<li>ESP8266 / ESP32</li>
<li>DS18B20 temperature sensor on the OneWire bus</li>
<li>Relay SRD-5VDC-SL-C / OMRON G3MB-202P used for boiler switching (Active-LOW signal)</li>
<b>HTML pages running on ESP8266 / ESP32 platform:</b>
<li><b>/</b> - root page containing form, current logic output for relay, current and target temperature, hysteresis</li>
<li><b>/action.html</b> - processes values from the form, writes them to the emulated EEPROM memory, redirects the user back to the root page</li>
<li><b>/get_data.json</b> - distributes data on current temperature, reference temperature and hysteresis to a third party (computer, microcontroller, other client ...) in JSON format - can be used with an example JSON client that can send data to MQTT Broker, for example to home automation</li>
<li>and other system subpages to control the output, change the mode</li>
<hr>	
<p style="text-align: justify;">		
<b>The resolution of the DS18B20 sensor during measurement is 12-bits, which is indicated by the resolution at 0.0625 ° C. Data via the OneWire bus can be returned to the microcontroller on demand in 500 to 1000 ms.</b>	
The electromagnetic relay SRD-5VDC-SL-C, which is used in the project, allows switching up to 10A at 230V - power 2300W.
In case of switching a DC circuit (load) it is possible to switch 300W (10A at 30V DC).
Alternatively, the OMRON G3MB-202P SSR relay is fully compatible for the wiring diagram, which is only suitable for non-inductive loads and exclusively for AC circuits.
Maximum switching power 460W (230V, 2A). <b> The thermostat can be used all year round. In case of unnecessary control, it is possible to physically disconnect the output and use the thermostat as a WiFi thermometer to obtain data from the room where it is located. </b>
The thermostat logic is executed every 10 seconds independently of the web server and connected clients, no keep-alive connection is required to execute it.
Each time the logic is executed, the thermostat also writes information about the current IP address or mDNS record (if used with mDNS firmware) on the UART thermostat and thus gives the user information on where the thermostat is accessible with its web interface in the LAN network.
In addition, it also lists the dynamic free memory - HEAP, which is at the level of 40 to 44kB, as well as the current state of the output with notification of the change if it occurs -> (if the decision threshold flows to + or to -).
<b>The 3V3 GPIO operating logic of the ESP8266 and ESP32 microcontrollers is sufficient for a digital change signal, but the relay must be powered to 5V from the VUSB and VIN, respectively.</b>
</p>

<b>Web interface for WiFi thermostat allows:</b>
<li>View in real time the temperature from the DS18B20 sensor, the device uptime, the output value with dynamic change, the currently set configuration data for the thermostat, i. target temperature and hysteresis</li>
<li>Modify the target (reference) temperature <del>in the range of 5 to 50 °C with a 0.25 °C step</del><img src="https://i.imgur.com/zMsp0cr.png" width="20px" height="20px" data-toggle="tooltip2" data-placement="right" title="Scope removed in version 1.0.2 due to non-decimal point support for input type number on Android OS"></li>
<li>Modify hysteresis <del>in the range of 0 to 10 °C with a 0.25 °C step</del><img src="https://i.imgur.com/zMsp0cr.png" width="20px" height="20px" data-toggle="tooltip2" data-placement="right" title="Scope removed in version 1.0.2 due to non-decimal point support for input type number on Android OS"></li>
<div class="alert alert-danger">
  <strong>Program implementation of a thermostat with automatic mode is experimental!</strong>
</div>
<b>Boiler ON / OFF control - automatic mode:</b> 
<li>Example ON / OFF of heating control - <font color="red">VISUALIZATION IS NOT PART OF THE PROJECT</font></li>	
<li>The boiler is active until the target temperature + hysteresis is reached</li>
<li>The visualization of water temperatures shows the so-called heating run-up and subsequent cooling of the water until the heating activity is repeated, when the measured temperature is below the set target temperature - hysteresis</li>		
<img src="https://i.imgur.com/IDWLuOr.png" style="display: block; max-width: 100%; height: auto;" alt="ZAP/VYP regulácia kotla s hysterézou" title="ZAP/VYP regulácia kotla s hysterézou">   
<p style="text-align: justify;">
<b>A manual control mode (hard ON / OFF) has been implemented in the basic version of the WiFi thermostat (without mDNS recording) with the possibility of switching between manual and automatic mode. </b>
The web interface is designed to adapt to larger and smaller screens. It is responsive, supporting widescreen high-definition screens as well as mobile devices.
The interface uses imported CSS styles of the Bootstrap framework from an external CDN server, which loads the client-side device when opening a page running on ESP.
By importing CSS styles from an external server, it will reduce the power and memory load of the microcontroller.
</p>
<hr>
<p style="text-align: justify;">
In order to keep the set values of the thermostat even after a power failure, they are stored in the EEPROM memory ESP, which is emulated in the flash memory, as the platform does not have a physical EEPROM chip (memory).
Reference temperature to offset 10, hysteresis to offset 100. Each of the values occupies a maximum of 5B in the EEPROM memory + the end character.
The data is overwritten only when the HTML form is sent, so the operation of the thermostat is as gentle as possible to the EEPROM memory for its maximum durability.
The output state exists only in RAM memory, it is not stored in flash memory.
If the device does not have anything stored on the mentioned EEPROM offsets at the first start-up, automatic writing will be performed with default values - reference: 20.25 °C, hysteresis 0.00 °C, so-called fail-safe solution.
ESP8266 and ESP32 use the EEPROM.put() function in conjunction with EEPROM.commit() to work with EEPROM memory and EEPROM.get() to read data from EEPROM, which supports any data type, in our case float().
</p>
<p style="text-align: justify;">
Using the Refresh meta tag, the web server refreshes the entire page every 30 seconds, and the approximate time to refresh is also written to the HTML page via Javascript.
By this time it is necessary to write the change for the thermostat, otherwise the input windows for numerical inputs to the form will be reset when the page is refreshed.
As the built-in Ethernet library does not include the use of an asynchronous web server (which can be used, for example, with the Espressif ESP8266 / ESP32 microcontrollers), it is necessary to rewrite the entire page.
</p>
<hr>
<p style="text-align: justify;">
The dynamic data that is mainly changing is the current value of the output - <b><font color="#27AE60">Turned on</font></b> / <b><font color="red">Turned off</font></b>, which informs the operator about the actual state of the output together with the color coding. 
Since the system logic is executed independently of the web server, the output may already be in a different state than currently currently listed in the web application. The change of output is immediately written to the UART monitor, for example.
On the thermostat's website, the user will also find information about the device's uptime (how long it has been running), i. time in days, hours, minutes and seconds. <b> The thermostat is only intended for indoor temperatures! </b> (above 0 ° C), to which the system logic is adapted!
The thermostat can replace an existing room thermostat, it can temporarily replace the heater in the aquarium / terrarium to maintain a constant temperature.
</p>
<div class="alert alert-danger">
	<strong>The author of the WiFi thermostat is not responsible for the functionality of the thermostat, boiler failure, electric shock due to improper installation of the thermostat in the network.</strong> The thermostat is distributed under the MIT license.
</div>	
<b>Main page for modification of target temperature and hysteresis - example of switched on output:</b>
<div class="alert alert-info">
	<strong>Sample data</strong>
	<li><b>Target temperature:</b>  22.75 °C</li>
	<li><b>Hysteresis:</b>  0.25 °C</li>
	<li><b>Measured data:</b>  22.49 °C</li>
	<li><b>Output:</b>  <font color="#27AE60">ON</font></li>
	<hr>
	<p style="text-align: justify;">
		The thermostat heats from a measured temperature of 22.49 °C and below.
If the temperature reaches 23.01 °C, the output is switched off, the signaling relay opens and the gas boiler stops heating.
The heating and cooling of the room in which the measurements are performed takes place. 
Thermostat is not reactivated until the temperature reaches 22.49 °C or lower.	
	</p>	
</div>

<b>Main page for target temperature and hysteresis modification:</b>
<img src="https://i.imgur.com/dBXiDLN.png" style="display: block; max-width: 100%; height: auto;" alt="WiFi thermostat - Main overview with modification of target temperature and hysteresis" title="WiFi thermostat - Main overview with modification of target temperature and hysteresis">        			

<b>Processing of datas that user entered by HTML form:</b>
<img src="https://i.imgur.com/QaGCYGh.png" style="display: block; max-width: 100%; height: auto;" alt="WiFi thermostat - data processing from HTML form" title="WiFi thermostat - data processing from HTML form">        			

<b>JSON web server output in browser / client via websocket:</b>
<center><img src="https://i.imgur.com/iqxV12k.png" style="display: block; max-width: 100%; height: auto;" alt="WiFi termostat - JSON output" title="WiFi termostat - JSON output"></center>        		

<b>Output to UART monitor - system logic + set IP address, mDNS record:</b>
<center><img src="https://i.imgur.com/gWm9izE.png" style="display: block; max-width: 100%; height: auto;" alt="WiFi termostat - UART output with mDNS record, IP address of thermostat" title="WiFi termostat - UART output with mDNS record, IP address of thermostat"></center>        		
<hr><center><h4>Available libraries for microcontrollers (ESP)</h4></center><hr>
<div class="alert alert-danger">
	Library archive (.zip) expand to <strong>C:/Users/[User]/Documents/Arduino/libraries</strong>
</div>
<div class="table-responsive">   
<table class="table" style="border: 1px solid black;">
<thead>
<tr>
<th style="width: 25%">Library name</th>
<th style="width: 50%">Library function</th>
<th style="width: 25%">Download</th>
</tr>
</thead>
<tbody>
<tr>
<td style="width: 25%"><b>Dallas</b></td>
<td style="width: 50%">
<p style="text-align: justify;">
Library for ESP8266 and ESP32 microcontrollers.
It allows communication with the Dallas DS18B20 sensor on the OneWire bus. Possibility of communication after normal or parasitic connection. 
</p>
</td>
<td style="width: 25%"><a href="https://minhaskamal.github.io/DownGit/#/home?url=https://github.com/martinius96/termostat-ethernet/tree/master/src/dallas" class="btn btn-success" role="button">Download</a></td>
</tr>
<tr>
<td style="width: 25%"><b>WiFiManager</b></td>
<td style="width: 50%">
<p style="text-align: justify;">
Library for ESP8266 and ESP32 microcontrollers.
Creates an access point (AP) and Captive portal for configuring a WiFi thermostat on a home WiFi network.
</p>
</td>
<td style="width: 25%"><a href="https://minhaskamal.github.io/DownGit/#/home?url=https://github.com/martinius96/WiFi-termostat/tree/main/src/WiFiManager-0.16.0" class="btn btn-success" role="button">Download</a></td>
</tr>
<tr>
<td style="width: 25%"><b>DNS Server</b></td>
<td style="width: 50%">
<p style="text-align: justify;">
ESP32 microcontroller library.
Required for WiFiManager library to work properly.
</p>
</td>
<td style="width: 25%"><a href="https://minhaskamal.github.io/DownGit/#/home?url=https://github.com/martinius96/WiFi-termostat/tree/main/src/DNSServer---esp32-master" class="btn btn-success" role="button">Download</a></td>
</tr>
</tbody>
</table>
</div>
<hr>
<h3 style="display: none;"><font color="#2ECC71">WiFi thermostat - source code - ESP8266</font></h3>
<pre style="background-color:#2ECC71; display: none;">
/*|----------------------------------------------------------|*/
/*|HTTP webserver - WiFi thermostat - ESP8266 + DS18B20      |*/
/*|AUTHOR: Martin Chlebovec                                  |*/
/*|EMAIL: martinius96@gmail.com                              |*/
/*|DONATE: paypal.me/chlebovec                               |*/
/*|----------------------------------------------------------|*/

#include &lt;ESP8266WiFi.h>
#include &lt;ESP8266WebServer.h>
#include &lt;WiFiManager.h>
ESP8266WebServer server(80);
#include &lt;DNSServer.h>
#include &lt;EEPROM.h>
#include &lt;OneWire.h>
#include &lt;DallasTemperature.h>

#define ONE_WIRE_BUS 5 //D1
OneWire oneWire(ONE_WIRE_BUS);
DallasTemperature sensorsA(&oneWire);
const int rele = 4; //D2
unsigned long cas = 0;
String stav = "OFF";
float teplota;
long day = 86400000; // 86400000 milliseconds in a day
long hour = 3600000; // 3600000 milliseconds in an hour
long minute = 60000; // 60000 milliseconds in a minute
long second =  1000; // 1000 milliseconds in a second
float rezim;
boolean isFloat(String tString) {
  String tBuf;
  boolean decPt = false;

  if (tString.charAt(0) == '+' || tString.charAt(0) == '-') tBuf = &tString[1];
  else tBuf = tString;

  for (int x = 0; x &lt; tBuf.length(); x++)
  {
    if (tBuf.charAt(x) == '.' || tBuf.charAt(x) == ',') {
      if (decPt) return false;
      else decPt = true;
    }
    else if (tBuf.charAt(x) &lt; '0' || tBuf.charAt(x) > '9') return false;
  }
  return true;
}

void writeString(char add, float data)
{
  EEPROM.put(add, (data * 1000));
  EEPROM.commit();
}


float read_String(char add)
{
  float payload = 0;
  float data = EEPROM.get(add, payload);
  return (data / 1000);
}

void handleRoot() {
  int days = millis() / day ;                                //number of days
  unsigned int hours = (millis() % day) / hour;                       //the remainder from days division (in milliseconds) divided by hours, this gives the full hours
  unsigned int minutes = ((millis() % day) % hour) / minute ;         //and so on...
  unsigned int seconds = (((millis() % day) % hour) % minute) / second;
  String stranka = F("&lt;!DOCTYPE html>");
  stranka += F("&lt;html>");
  stranka += F("&lt;head>");
  stranka += F("&lt;meta charset='utf-8'>");
  stranka += F("&lt;meta name='author' content='Martin Chlebovec'>");
  stranka += F("&lt;meta http-equiv='Refresh' content='30'; />");
  stranka += F("&lt;meta name='viewport' content='width=device-width, initial-scale=1'>");
  stranka += F("&lt;link rel='stylesheet' href='https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css'>");
  stranka += F("&lt;script type='text/javascript'> window.smartlook||(function(d) {"); 
  stranka += F("var o=smartlook=function(){ o.api.push(arguments)},h=d.getElementsByTagName('head')[0];");
  stranka += F("var c=d.createElement('script');o.api=new Array();c.async=true;c.type='text/javascript';");
  stranka += F("c.charset='utf-8';c.src='https://rec.smartlook.com/recorder.js';h.appendChild(c); })(document);"); 
  stranka += F("smartlook('init', '63ff3bf4db2f85029b19856425a4f2086533c9e6');"); 
  stranka += F("&lt;/script>");  
  stranka += F("&lt;script type='text/javascript'>");
  stranka += F("var timeleft = 30;");
  stranka += F("var downloadTimer = setInterval(function(){");
  stranka += F("if(timeleft &lt;= 0){");
  stranka += F("clearInterval(downloadTimer);");
  stranka += F("document.getElementById(\"countdown\").innerHTML = \"Refreshing...\";");
  stranka += F("} else {");
  stranka += F("document.getElementById(\"countdown\").innerHTML = timeleft + \" seconds to refresh\";");
  stranka += F("}");
  stranka += F("timeleft -= 1;");
  stranka += F("}, 1000);");
  stranka += F("&lt;/script>");
  stranka += F("&lt;title>WiFi thermostat - ESP8266&lt;/title>");
  stranka += F("&lt;/head>");
  stranka += F("&lt;body>");
  stranka += F("&lt;center>&lt;h3>WiFi thermostat - ESP8266:&lt;/h3>");
  if (rezim == 0.00) {
    stranka += F("&lt;form action='/action.html' method='post'>");
    stranka += "&lt;b>Target temperature:&lt;/b>&lt;br>&lt;input type='text' id='fname' name='fname' min='5' max='50' step='0.25' value=" + String(read_String(10)) + ">&lt;br>";
    stranka += "&lt;b>Hysteresis:&lt;/b>&lt;br>&lt;input type='text' id='fname2' name='fname2' min='0' max='10' step='0.25' value=" + String(read_String(100)) + ">&lt;br>";
    stranka += F("&lt;input type='submit' class='btn btn-success' value='Send'>");
    stranka += F("&lt;/form>");
    stranka += F("&lt;a href='manual.html' class='btn btn-primary' role='button'>Manual mode&lt;/a>&lt;hr>");
  } else if (rezim == 1.00) {
    if (stav == "ON") {
      stranka += F("&lt;a href='vyp.html' class='btn btn-danger' role='button'>Turn off&lt;/a>&lt;br>");
    }
    if (stav == "OFF") {
      stranka += F("&lt;a href='zap.html' class='btn btn-success' role='button'>Turn on&lt;/a>&lt;br>");
    }
    stranka += F("&lt;a href='automat.html' class='btn btn-primary' role='button'>Automatic mode&lt;/a>&lt;hr>");
  }
  if (stav == "ON") {
    stranka += F("&lt;b>&lt;font color='green'>Output: ON&lt;/font>&lt;/b>");
  }
  if (stav == "OFF") {
    stranka += F("&lt;b>&lt;font color='red'>Output: OFF&lt;/font>&lt;/b>");
  }
  stranka += F("&lt;div id=\"countdown\">&lt;/div>");
  stranka += F("&lt;b>Current sensor DS18B20 temperature:&lt;/b> ");
  stranka += String(teplota);
  stranka += F(" °C");
  stranka += F("&lt;hr>");
  stranka += F("&lt;b>Uptime: &lt;/b>");
  stranka += String(days);
  stranka += F("d");
  stranka += F(" ");
  stranka += String(hours);
  stranka += F("h");
  stranka += F(" ");
  stranka += String(minutes);
  stranka += F("m");
  stranka += F(" ");
  stranka += String(seconds);
  stranka += F("s");
  stranka += F("&lt;h3>Author: Martin Chlebovec - martinius96@gmail.com - https://martinius96.github.io/WiFi-termostat/en/&lt;/h3>");
  stranka += F("&lt;h4>Free version - 1.0.4 build: 06. Oct. 2021&lt;/h4>");
  stranka += F("&lt;/center>");
  stranka += F("&lt;/body>");
  stranka += F("&lt;/html>");
  server.send(200, "text/html", stranka);
}

void handleBody() {
  if (server.hasArg("fname")) {
    String target_temp = server.arg("fname");
    // float cielova_teplota = target_temp.toFloat();

    if (isFloat(target_temp)) {
      float cielova_teplota = target_temp.toFloat();
      writeString(10, cielova_teplota);
    } else {
      Serial.println(F("No number was entered in the input according to the target temperature!"));
      Serial.println(F("Writing into EEPROM prohibited!"));
    }
  }
  if (server.hasArg("fname2")) {
    String hysteresis = server.arg("fname2");
    if (isFloat(hysteresis)) {
      float hystereza = hysteresis.toFloat();
      writeString(100, hystereza);
    } else {
      Serial.println(F("No number was entered in the input according to the hysteresis!"));
      Serial.println(F("Writing into EEPROM prohibited!"));
    }
  }
  String stranka = F("&lt;!DOCTYPE html>");
  stranka += F("&lt;html>");
  stranka += F("&lt;head>");
  stranka += F("&lt;meta charset='utf-8'>");
  stranka += F("&lt;meta http-equiv='Refresh' content='5; url=/' />");
  stranka += F("&lt;title>WiFi thermostat - ESP8266 - data processing&lt;/title>");
  stranka += F("&lt;/head>");
  stranka += F("&lt;body>");
  stranka += F("&lt;center>&lt;h3>Server received data from HTML form:&lt;/h3>");
  stranka += "&lt;li>&lt;b>Target temperature: &lt;/b>" + String(read_String(10)) + " °C&lt;/li>";
  stranka += "&lt;li>&lt;b>Hysteresis: &lt;/b>" + String(read_String(100)) + " °C&lt;/li>";
  stranka += F("&lt;b>Redirecting... Please wait&lt;/b>&lt;/center>");
  stranka += F("&lt;/body>");
  stranka += F("&lt;/html>");
  server.send(200, "text/html", stranka);
}

void handleGet() {
  String stranka = "{\n";
  stranka += F("\"Hysteresis\":");
  stranka += String(read_String(100));
  stranka += F(",\n");
  stranka += F("\"Target_Temperature\":");
  stranka += String(read_String(10));
  stranka += F(",\n");
  stranka += F("\"Actual_Temperature\":");
  stranka += String(teplota) + "\n";
  stranka += F("}\n");
  server.send(200, "application/json", stranka);
}

void handleZAP() {
  stav = "ON";
  digitalWrite(rele, LOW);
  String stranka = F("&lt;!DOCTYPE html>");
  stranka += F("&lt;html>");
  stranka += F("&lt;head>");
  stranka += F("&lt;meta charset='utf-8'>");
  stranka += F("&lt;meta http-equiv='Refresh' content='0; url=/' />");
  stranka += F("&lt;/head>");
  stranka += F("&lt;/html>");
  server.send(200, "text/html", stranka);
}

void handleAuto() {
  writeString(150, 0.00);
  rezim = read_String(150);
  String stranka = F("&lt;!DOCTYPE html>");
  stranka += F("&lt;html>");
  stranka += F("&lt;head>");
  stranka += F("&lt;meta charset='utf-8'>");
  stranka += F("&lt;meta http-equiv='Refresh' content='0; url=/' />");
  stranka += F("&lt;/head>");
  stranka += F("&lt;/html>");
  server.send(200, "text/html", stranka);
}
void handleManual() {
  writeString(150, 1.00);
  rezim = read_String(150);
  String stranka = F("&lt;!DOCTYPE html>");
  stranka += F("&lt;html>");
  stranka += F("&lt;head>");
  stranka += F("&lt;meta charset='utf-8'>");
  stranka += F("&lt;meta http-equiv='Refresh' content='0; url=/' />");
  stranka += F("&lt;/head>");
  stranka += F("&lt;/html>");
  server.send(200, "text/html", stranka);
}
void handleVYP() {
  stav = "OFF";
  digitalWrite(rele, HIGH);
  String stranka = F("&lt;!DOCTYPE html>");
  stranka += F("&lt;html>");
  stranka += F("&lt;head>");
  stranka += F("&lt;meta charset='utf-8'>");
  stranka += F("&lt;meta http-equiv='Refresh' content='0; url=/' />");
  stranka += F("&lt;/head>");
  stranka += F("&lt;/html>");
  server.send(200, "text/html", stranka);
}
void setup() {
  Serial.begin(115200);
  WiFiManager wifiManager;
  wifiManager.autoConnect("WiFi_TERMOSTAT_AP");
  EEPROM.begin(512);  //Initialize EEPROM
  float a = read_String(10);
  float b = read_String(100);
  float c = read_String(150);
  if (isnan(a)) {
    writeString(10, 20.25);
  }
  if (isnan(b)) {
    writeString(100, 0.25);
  }
  if (isnan(c)) {
    writeString(150, 0.00);
  }
  sensorsA.begin();
  pinMode(rele, OUTPUT);
  digitalWrite(rele, HIGH);
  sensorsA.requestTemperatures();
  delay(750);
  Serial.println(F("WiFi thermostat - Author: Martin Chlebovec"));
  Serial.println("");
  Serial.println(F("WiFi connected."));
  Serial.println(F("IP address: "));
  Serial.println(WiFi.localIP());
  server.on("/", handleRoot);
  server.on("/get_data.json", handleGet);
  server.on("/automat.html", handleAuto);
  server.on("/manual.html", handleManual);
  server.on("/zap.html", handleZAP);
  server.on("/vyp.html", handleVYP);
  server.on("/action.html", HTTP_POST, handleBody);
  server.begin();
}

void loop() {
  if ((millis() - cas) >= 10000 || cas == 0) {
    cas = millis();
    teplota = sensorsA.getTempCByIndex(0);
    Serial.println();
    Serial.println(F("----------------------------------------------"));
    Serial.print(F("IP address of ESP8266 thermostat: "));
    Serial.print(WiFi.localIP());
    Serial.print(F(", for access via mDNS use http://"));
    Serial.print(WiFi.localIP());
    Serial.println(F("/"));
    Serial.print(F("Free HEAP: "));
    Serial.print(ESP.getFreeHeap());
    Serial.println(F(" B"));
    Serial.print(F("Actual DS18B20 temperature: "));
    Serial.print(String(teplota));
    Serial.println(F(" °C"));
    sensorsA.requestTemperatures();
    rezim = read_String(150);
    if (rezim == 0.00) {
      float cielova_teplota = read_String(10);
      float  hystereza = read_String(100);
      float minus_hystereza_teplota = (-1 * hystereza);
      float rozdiel = cielova_teplota - teplota; //21 - 20
      if (rozdiel > hystereza) {
        Serial.println(F("Output ON"));
        stav = "ON";
        digitalWrite(rele, LOW);
      } else if (rozdiel &lt; minus_hystereza_teplota) {
        Serial.println(F("Output OFF"));
        stav = "OFF";
        digitalWrite(rele, HIGH);
      } else {
        Serial.println(F("Difference between the target and actual temperature is not above or below the hysteresis. The output status does not change."));
        Serial.print(F("Actual output state: "));
        Serial.println(stav);
      }
    } else {
      Serial.print(F("Manual operation mode is used, output status: "));
      Serial.println(stav);
    }
  }
  server.handleClient();
  yield();
}
</pre>
<h3 style="display: none;"><font color="#3498DB">WiFi thermostat - source code - ESP32</font></h3>
<pre style="background-color:#3498DB; display:none;">
/*|----------------------------------------------------------|*/
/*|HTTP webserver - WiFi thermostat - ESP32 + DS18B20        |*/
/*|AUTHOR: Martin Chlebovec                                  |*/
/*|EMAIL: martinius96@gmail.com                              |*/
/*|DONATE: paypal.me/chlebovec                               |*/
/*|----------------------------------------------------------|*/

#include &lt;WiFi.h>
#include &lt;WebServer.h>
#include &lt;WiFiManager.h>
#include &lt;ESPmDNS.h>
WebServer server(80);
#include &lt;EEPROM.h>
#include &lt;OneWire.h>
#include &lt;DallasTemperature.h>

#define ONE_WIRE_BUS 23
OneWire oneWire(ONE_WIRE_BUS);
DallasTemperature sensorsA(&oneWire);
const int rele = 22; //D2
unsigned long cas = 0;
String stav;
float teplota;
long day = 86400000; // 86400000 milliseconds in a day
long hour = 3600000; // 3600000 milliseconds in an hour
long minute = 60000; // 60000 milliseconds in a minute
long second =  1000; // 1000 milliseconds in a second

boolean isFloat(String tString) {
  String tBuf;
  boolean decPt = false;

  if (tString.charAt(0) == '+' || tString.charAt(0) == '-') tBuf = &tString[1];
  else tBuf = tString;

  for (int x = 0; x &lt; tBuf.length(); x++)
  {
    if (tBuf.charAt(x) == '.' || tBuf.charAt(x) == ',') {
      if (decPt) return false;
      else decPt = true;
    }
    else if (tBuf.charAt(x) &lt; '0' || tBuf.charAt(x) > '9') return false;
  }
  return true;
}

void writeString(char add, float data)
{
  EEPROM.put(add, (data * 1000));
  EEPROM.commit();
}


float read_String(char add)
{
  float payload = 0;
  float data = EEPROM.get(add, payload);
  return (data / 1000);
}

void handleRoot() {
  int days = millis() / day ;                                //number of days
  unsigned int hours = (millis() % day) / hour;                       //the remainder from days division (in milliseconds) divided by hours, this gives the full hours
  unsigned int minutes = ((millis() % day) % hour) / minute ;         //and so on...
  unsigned int seconds = (((millis() % day) % hour) % minute) / second;
  String stranka = F("&lt;!DOCTYPE html>");
  stranka += F("&lt;html>");
  stranka += F("&lt;head>");
  stranka += F("&lt;meta charset='utf-8'>");
  stranka += F("&lt;meta name='author' content='Martin Chlebovec'>");
  stranka += F("&lt;meta http-equiv='Refresh' content='30'; />");
  stranka += F("&lt;meta name='viewport' content='width=device-width, initial-scale=1'>");
  stranka += F("&lt;link rel='stylesheet' href='https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css'>");
  stranka += F("&lt;script type='text/javascript'> window.smartlook||(function(d) {"); 
  stranka += F("var o=smartlook=function(){ o.api.push(arguments)},h=d.getElementsByTagName('head')[0];");
  stranka += F("var c=d.createElement('script');o.api=new Array();c.async=true;c.type='text/javascript';");
  stranka += F("c.charset='utf-8';c.src='https://rec.smartlook.com/recorder.js';h.appendChild(c); })(document);"); 
  stranka += F("smartlook('init', '63ff3bf4db2f85029b19856425a4f2086533c9e6');"); 
  stranka += F("&lt;/script>");
  stranka += F("&lt;script type='text/javascript'>");
  stranka += F("var timeleft = 30;");
  stranka += F("var downloadTimer = setInterval(function(){");
  stranka += F("if(timeleft &lt;= 0){");
  stranka += F("clearInterval(downloadTimer);");
  stranka += F("document.getElementById(\"countdown\").innerHTML = \"Refreshing...\";");
  stranka += F("} else {");
  stranka += F("document.getElementById(\"countdown\").innerHTML = timeleft + \" seconds to refresh\";");
  stranka += F("}");
  stranka += F("timeleft -= 1;");
  stranka += F("}, 1000);");
  stranka += F("&lt;/script>");
  stranka += F("&lt;title>WiFi thermostat - ESP32&lt;/title>");
  stranka += F("&lt;/head>");
  stranka += F("&lt;body>");
  stranka += F("&lt;center>&lt;h3>Enter datas for web server:&lt;/h3>");
  stranka += F("&lt;form action='/action.html' method='post'>");
  stranka += "&lt;b>Target temperature:&lt;/b>&lt;br>&lt;input type='text' id='fname' name='fname' min='5' max='50' step='0.25' value=" + String(read_String(10)) + ">&lt;br>";
  stranka += "&lt;b>Hysteresis:&lt;/b>&lt;br>&lt;input type='text' id='fname2' name='fname2' min='0' max='10' step='0.25' value=" + String(read_String(100)) + ">&lt;br>";
  stranka += F("&lt;input type='submit' class='btn btn-success' value='Send'>");
  stranka += F("&lt;/form>&lt;hr>");
  if (stav == "ON") {
    stranka += F("&lt;b>&lt;font color='green'>Output: ON&lt;/font>&lt;/b>");
  }
  if (stav == "OFF") {
    stranka += F("&lt;b>&lt;font color='red'>Output: OFF&lt;/font>&lt;/b>");
  }
  stranka += F("&lt;div id=\"countdown\">&lt;/div>");
  stranka += F("&lt;b>Current sensor DS18B20 temperature:&lt;/b> ");
  stranka += String(teplota);
  stranka += F(" °C");
  stranka += F("&lt;hr>");
  stranka += F("&lt;b>Uptime: &lt;/b>");
  stranka += String(days);
  stranka += F("d");
  stranka += F(" ");
  stranka += String(hours);
  stranka += F("h");
  stranka += F(" ");
  stranka += String(minutes);
  stranka += F("m");
  stranka += F(" ");
  stranka += String(seconds);
  stranka += F("s");
  stranka += F("&lt;h3>Author: Martin Chlebovec - martinius96@gmail.com - https://martinius96.github.io/WiFi-termostat/en/&lt;/h3>");
  stranka += F("&lt;h4>Free version - 1.0.4 build: 10. Oct. 2021&lt;/h4>");
  stranka += F("&lt;/center>");
  stranka += F("&lt;/body>");
  stranka += F("&lt;/html>");
  server.send(200, "text/html", stranka);
}

void handleBody() {
  if (server.hasArg("fname")) {
    String target_temp = server.arg("fname");
    // float cielova_teplota = target_temp.toFloat();

    if (isFloat(target_temp)) {
      float cielova_teplota = target_temp.toFloat();
      writeString(10, cielova_teplota);
    } else {
      Serial.println(F("No number was entered in the target temperature input field!"));
      Serial.println(F("Datas will be not stored in EEPROM!"));
    }
  }
  if (server.hasArg("fname2")) {
    String hysteresis = server.arg("fname2");
    if (isFloat(hysteresis)) {
      float hystereza = hysteresis.toFloat();
      writeString(100, hystereza);
    } else {
      Serial.println(F("No number was entered in the hysteresis input field!"));
      Serial.println(F("Datas will be not stored in EEPROM!"));
    }
  }
  String stranka = F("&lt;!DOCTYPE html>");
  stranka += F("&lt;html>");
  stranka += F("&lt;head>");
  stranka += F("&lt;meta charset='utf-8'>");
  stranka += F("&lt;meta http-equiv='Refresh' content='5; url=/' />");
  stranka += F("&lt;title>WiFi thermostat - ESP32 - data processing&lt;/title>");
  stranka += F("&lt;/head>");
  stranka += F("&lt;body>");
  stranka += F("&lt;center>&lt;h3>Server received datas from HTML form:&lt;/h3>");
  stranka += "&lt;li>&lt;b>Target temperature: &lt;/b>" + String(read_String(10)) + " °C&lt;/li>";
  stranka += "&lt;li>&lt;b>Hysteresis: &lt;/b>" + String(read_String(100)) + " °C&lt;/li>";
  stranka += F("&lt;b>Redirecting... Please wait&lt;/b>&lt;/center>");
  stranka += F("&lt;/body>");
  stranka += F("&lt;/html>");
  server.send(200, "text/html", stranka);
}

void handleGet() {
  String stranka = "{\n";
  stranka += F("\"Hysteresis\":");
  stranka += String(read_String(100));
  stranka += F(",\n");
  stranka += F("\"Target_Temperature\":");
  stranka += String(read_String(10));
  stranka += F(",\n");
  stranka += F("\"Actual_Temperature\":");
  stranka += String(teplota) + "\n";
  stranka += F("}\n");
  server.send(200, "application/json", stranka);
}

void setup() {
  Serial.begin(115200);
  WiFiManager wifiManager;
  wifiManager.autoConnect("WiFi_TERMOSTAT_AP");
  EEPROM.begin(512);  //Initialize EEPROM
  float a = read_String(10);
  float b = read_String(100);
  if (isnan(a)) {
    writeString(10, 20.25);
  }
  if (isnan(b)) {
    writeString(100, 0.25);
  }
  sensorsA.begin();
  pinMode(rele, OUTPUT);
  digitalWrite(rele, HIGH);
  sensorsA.requestTemperatures();
  delay(750);
  Serial.println(F("Webapp created by: Martin Chlebovec"));
  Serial.println(F("Build 1.0.4 from 10. Oct 2021"));
  Serial.println(F("WiFi connected."));
  Serial.println(F("IP address of WiFi thermostat: "));
  Serial.println(WiFi.localIP());
  if (!MDNS.begin("wifi-termostat")) {
    Serial.println("Error setting up MDNS responder!");
    while (1) {
      delay(1000);
    }
  }
  Serial.println("mDNS responder running");
  Serial.println(F("Thermostat available at: http://wifi-termostat.local"));
  server.on("/", handleRoot);
  server.on("/get_data.json", handleGet);
  server.on("/action.html", HTTP_POST, handleBody);
  server.begin();
  MDNS.addService("http", "tcp", 80);
}

void loop() {
  if ((millis() - cas) >= 10000 || cas == 0) {
    cas = millis();
    teplota = sensorsA.getTempCByIndex(0);
    Serial.println();
    Serial.println(F("----------------------------------------------"));
    Serial.print(F("IP address of WiFi Thermostat: "));
    Serial.print(WiFi.localIP());
    Serial.print(F(", to access WiFi thermostat, visit http://"));
    Serial.print(WiFi.localIP());
    Serial.println(F("/"));
    Serial.println(F("Thermostat also available at: http://wifi-termostat.local via mDNS record"));
    Serial.print(F("Free HEAP: "));
    Serial.print(ESP.getFreeHeap());
    Serial.println(F(" B"));
    Serial.print(F("Current temperature: "));
    Serial.print(String(teplota));
    Serial.println(F(" °C"));
    sensorsA.requestTemperatures();
    float cielova_teplota = read_String(10);
    float  hystereza = read_String(100);
    float minus_hystereza_teplota = (-1 * hystereza);
    float rozdiel = cielova_teplota - teplota; //21 - 20
    if (rozdiel > hystereza) {
      Serial.println(F("Output on"));
      stav = "ON";
      digitalWrite(rele, LOW);
    } else if (rozdiel &lt; minus_hystereza_teplota) {
      Serial.println(F("Output off"));
      stav = "OFF";
      digitalWrite(rele, HIGH);
    } else {
      Serial.println(F("Difference between target and actual temp is not above or below the hysteresis. The output state does not change."));
      Serial.print(F("Actual state of output: "));
      Serial.println(stav);
    }
  }
  server.handleClient();
  yield();
}
</pre>
</div>
</div>
</div>
</body>
        <script>
$(document).ready(function(){
  $('[data-toggle="tooltip2"]').tooltip();   
});
</script>
</html>
